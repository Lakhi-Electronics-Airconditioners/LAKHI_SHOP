<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="View ALl the AC in are website">
    <title>Lakhi Airconditioners | AC Products</title>
    <link rel="icon" href="img/1x1-logo.png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.css">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.min.css">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('✅ Service Worker registered'))
                .catch(err => console.error('❌ Service Worker error:', err));
        }
    </script>
    
</head>
<body>
    <!-- Terms and Conditions Modal (Initial Agreement) -->
    <div id="tacpp" class="w3-modal-content">
        <div class="w3-center" style="margin-bottom:20px;">
            <span 
                onclick="closeModal()" 
                class="close-button" 
                title="Close Modal">
                Close ×
            </span>
            <h2>Please Agree to Proceed</h2>
        </div>
        <form class="w3-container">
            <!-- Agreement Checkbox -->
            <div class="w3-section" style="margin-bottom:20px; text-align:left;">
                <input type="checkbox" id="agree">
                <label for="agree">
                    I agree to the 
                    <a href="../info/TAC">
                        Terms and Conditions
                    </a> 
                    and 
                    <a href="../info/PP">
                        Privacy Policy
                    </a>.
                </label>
            </div>
            <!-- Disclaimer Section -->
            <p style="font-size:14px; margin-bottom:20px;">
                * Prices may not be accurate, and not all products are listed.<br>
                *product may not be in stock or may not even be buyable anymore<br>
                * price may go down because of some gst/cst payment things
            </p>
            <!-- Continue Button -->
            <div class="w3-center">
                <button 
                    class="btn-modal" 
                    onclick="continueAction(event)">
                    Continue
                </button>
            </div>
        </form>
    </div>

    <!-- Terms and Conditions Update Modal -->
    <div id="updateTacppModal" class="w3-modal-content">
        <div class="w3-center" style="margin-bottom:20px;">
            <span 
                onclick="closeUpdateModal()" 
                class="close-button" 
                title="Close Modal">
                Close ×
            </span>
            <h2>Terms and Conditions Updated</h2>
        </div>
        <form class="w3-container">
            <!-- Update Agreement Checkbox -->
            <div class="w3-section" style="margin-bottom:20px; text-align:left;">
                <p>Our Terms and Conditions and Privacy Policy have been updated. Please review the changes and agree to continue.</p>
                <input type="checkbox" id="agreeUpdate">
                <label for="agreeUpdate">
                    I agree to the updated 
                    <a href="../info/TAC">
                        Terms and Conditions
                    </a> 
                    and 
                    <a href="../info/PP">
                        Privacy Policy
                    </a>.
                </label>
            </div>
            <!-- Continue Button for Update -->
            <div class="w3-center">
                <button 
                    class="btn-modal" 
                    onclick="continueUpdateAction(event)">
                    Agree to Update
                </button>
            </div>
        </form>
    </div>
    <script src="TACPP.js" defer></script>
    <div class="header-NAV">
        <div class="container">
            <div class="navbar">
                <div class="logo"><img src="img/NABR/log.jpg" width="125px" alt="lakhi airconditioners logo"></div>
                <nav>
                    <ul id="Menuitems">
                        <li><a href="https://shop.lakhiairconditioners.com">Home</a></li>
                        <li><a href="about">About Us</a></li>
                        <li><a href="products">All Products</a></li>
                        <li><a href="contact">Contact Us</a></li>
                        <li><a href="account">Account</a></li>
                    </ul>
                </nav>
                <a href="cart"><img src="img/NABR/SCI.png" width="30px" alt="shopping cart button"></a>
                <img src="img/NABR/menu.png" class="menu-icon" onclick="menutoggle()" alt="menu button">
            </div>
        </div>
    </div>
    <div class="color-NAV"><br><br></div>

    <div class="small-container">
        <div class="small-container row row-2">
            <h2>AC Products</h2>
            <select id="sortSelect">
                <option value="name-asc">Default Sorting (A-Z)</option>
                <option value="name-desc">Sort Z-A</option>
                <option value="price-asc">Sort by Price: Low to High</option>
                <option value="price-desc">Sort by Price: High to Low</option>
                <option value="rating">Sort by Rating</option>
            </select>
        </div>
        
        <div class="small-container row" style="margin-top: 20px;">
            <div class="col-4">
                <label for="filterAcType">AC Type:</label>
                <select id="filterAcType">
                    <option value="All">All AC Types</option>
                </select>
            </div>
            <div class="col-4">
                <label for="filterAcTr">AC TR:</label>
                <select id="filterAcTr">
                    <option value="All">All TR</option>
                </select>
            </div>
            <div class="col-4">
                <label for="filterAcStar">AC Star Rating:</label>
                <select id="filterAcStar">
                    <option value="All">All Stars</option>
                </select>
            </div>
            <div class="col-4">
                <label for="filterInv">INV / NON-INV:</label>
                <select id="filterInv">
                    <option value="All">BOTH</option>
                </select>
            </div>
        </div>
        
        <div class="row" id="productListContainer">
            </div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="foot-col-1">
                    <h3>Download Our App</h3>
                    <p>Download App for Android but not <u>iphone</u> for now</p>
                    <div class="app-logo">
                        <a href="https://drive.google.com/uc?export=download&id=1jx18KtEjAwaQtto0XqbPWe8cz49oUuUG"><img src="img/NABR/apk-down.jpeg" alt="dowload lakhi shop apk button"></a>
                    </div>
                </div>
                <div class="foot-col-2">
                    <img src="img/log-w.png" width="200px" alt="lakhi airconditioners all white logo">
                    <p>Our Purpose Is to give the best deal and products to the Many.</p>
                </div>
                <div class="foot-col-3">
                    <h3>Useful links</h3>
                    <ul>
                        <li><a href="https://main.lakhiairconditioners.com/TAC">Terms and Conditions</a></li>
                        <li><a href="https://main.lakhiairconditioners.com/PP">Privacy Policy</a></li>
                        <li><a href="https://lakhiairconditioners.com">INFO</a></li>
                        <li><a href="https://maps.lakhiairconditioners.com">G-MAPS</a></li>
                    </ul>
                </div>
                <div class="foot-col-4">
                    <h3>Follow us</h3>
                    <ul>
                        <Li><a href="https://insta.lakhiairconditioners.com/">Instagram</a></Li>
                        <Li><a href="https://fb.lakhiairconditioners.com/">Facebook</a></Li>
                    </ul>
                    <h3 style="margin-top: 20px">Contact info</h3>
                    <ul>
                        <li><a href="tel:+919825513000">+919825513000</a></li>
                        <li><a href="mailto:info@lakhiairconditioners?subject=Feedback&amp;body=Hi%20there,%20I%20have%20some%20feedback%20for%20you.">info@lakhiairconditioners.com</a></li>
                        <li><a href="https://bc.lakhiairconditioners.com">Business-card</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <p class="copyright">&copy; 2025 Lakhi Airconditioners. All rights reserved.<br>
                all right given to fontawesome for their icons
                <a href="https://www.flaticon.com/free-icons/menu" title="menu icons">Menu icons created by ariefstudio - Flaticon</a></p>

        </div>
    </div>
    
    <script>
        var Menuitems = document.getElementById("Menuitems");
        Menuitems.style.maxHeight = "0px";
        function menutoggle() {
            if (Menuitems.style.maxHeight == "0px") {
                Menuitems.style.maxHeight = "200px";
            } else {
                Menuitems.style.maxHeight = "0px";
            }
        }

        // New function for handling image loading errors with fallbacks
        function handleImageError(imgElement, serialNo) {
            // Check if we've already tried the serial number fallback
            if (!imgElement.dataset.serialFallbackAttempted) {
                imgElement.dataset.serialFallbackAttempted = 'true'; // Mark as attempted
                imgElement.src = `img/PROC/${serialNo}.png`; // Try serial number image
                console.log(`Image failed for ${serialNo}. Trying fallback: img/PROC/${serialNo}.png`);
            } else {
                // If serial number fallback was already attempted and failed, use final default
                imgElement.onerror = null; // Prevent infinite loop for DP.png if it somehow fails
                imgElement.src = 'img/PROC/DP.png';
                console.log(`Serial number fallback failed for ${serialNo}. Using final fallback: img/PROC/DP.png`);
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-16u2n4IaGRmg88nsPmMYCGKp2jjL9Bg",
            authDomain: "lakhi-airconditioners.firebaseapp.com",
            projectId: "lakhi-airconditioners",
            storageBucket: "lakhi-airconditioners.firebasestorage.app",
            messagingSenderId: "284430318185",
            appId: "1:284430318185:web:ad09598be7a16ab46a00f8",
            measurementId: "G-LB63B1FRYC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Ensure this APP_ID matches the projectId in your firebaseConfig and your Python backend's APP_ID
        const FIRESTORE_APP_ID = "lakhi-airconditioners"; // This must match your Firebase project ID and APP_ID in Python scripts

        // Common reference to the products collection for consistency
        const productsCollectionRef = collection(db, "artifacts", FIRESTORE_APP_ID, "products");

        // --- Cart Functions ---
        function addToCart(serialNo, quantity, selectedSize, productUnit, productName, productPrice) {
            console.log('addToCart function entered.'); // Debugging log
            // *** CHANGED FROM 'cart' TO 'cartitems' ***
            let cart = JSON.parse(localStorage.getItem('cartitems')) || [];

            const existingItemIndex = cart.findIndex(item => item.serial_no === serialNo);

            if (existingItemIndex > -1) {
                cart[existingItemIndex].qty = (cart[existingItemIndex].qty || 1) + quantity;
            } else {
                cart.push({
                    serial_no: serialNo,
                    quantity: quantity,
                    size: selectedSize,
                    unit: productUnit,
                    name: productName,
                    price: productPrice
                });
            }

            // *** CHANGED FROM 'cart' TO 'cartitems' ***
            localStorage.setItem('cartitems', JSON.stringify(cart));
            alert(`${productName} added to cart! Quantity: ${quantity}`);
            console.log('Current cartitems:', JSON.parse(localStorage.getItem('cartitems'))); // Debugging log
            // You might want to update a cart count display here
        }
        // --- End Cart Functions ---

        // Function to generate star rating HTML
        function generateStars(rating) {
            let starsHTML = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<i class="fa-solid fa-star"></i>';
            }
            if (hasHalfStar) {
                starsHTML += '<i class="fa-solid fa-star-half-stroke"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<i class="fa-regular fa-star"></i>';
            }
            return starsHTML;
        }


        const productContainer = document.getElementById('productListContainer');
        const sortSelect = document.getElementById('sortSelect');
        const filterAcTypeSelect = document.getElementById('filterAcType');
        const filterAcTrSelect = document.getElementById('filterAcTr');
        const filterAcStarSelect = document.getElementById('filterAcStar');
        const filterAcinvSelect = document.getElementById('filterInv')

        let allProducts = [];
        let displayedProducts = [];

        // Function to render products
        function renderProducts(productsToRender) {
            productContainer.innerHTML = '';
            if (productsToRender.length === 0) {
                productContainer.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px;">No AC products found matching your criteria.</p>';
                return;
            }
            productsToRender.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('col-4');

                // Prepare variables for display
                const formattedPrice = product.price ? `₹${product.price.toLocaleString('en-IN')}` : 'Price on Request';
                const acTrDisplay = product['ac_tr'] ? `<p>TR: ${product['ac_tr']}</p>` : '';
                const acTypeDisplay = product['ac_type'] ? `<p>Type: ${product['ac_type']}</p>` : '';
                const acStarDisplay = product['ac_stars'] ? `<p>AC stars: ${product['ac_stars']}</p>` : '';
                const acInvDisplay = product['ac_inv'] ? `<p>INV / NON-INV: ${product['ac_inv']}</p>` : '';
                const stars = generateStars(product['rating'] || 0);
                const ratingSourcePath = product.rating_icon || '';
                const initialSelectedSizeForCart = product.size || '';
                
                productCard.innerHTML = `
                    <a href="product_detail?serial_no=${product.serial_no}" style="text-decoration: none; color: inherit;">
                        <img src="${product.image_url}" 
                             alt="${product.name}" 
                             onerror="handleImageError(this, '${product.serial_no}');"> 
                        <h4>${product.name} (S/N: ${product.serial_no})</h4>
                        <p>${formattedPrice}</p>
                        ${acTrDisplay}
                        ${acTypeDisplay}
                        ${acStarDisplay}
                        ${acInvDisplay}
                        <div class="rating">
                            <span>
                                ${generateStars(product['rating'] || 0)} 
                            </span>
                            ${ratingSourcePath ? `<p style="font-size: 10px; margin: 0;">Based on <img src="${ratingSourcePath}" style="width: 30px; height: 10px; vertical-align: middle;"></p>` : ''}
                        </div>
                    </a>
                    <div class="add-to-cart-container" style="text-align: center; margin-top: 10px;">
                        <a href="#" class="btn-Cart add-to-cart-btn" 
                           data-serial-no="${product.serial_no}" 
                           data-size="${initialSelectedSizeForCart}" 
                           data-unit="${product.unit || 'unit'}" 
                           data-name="${product.name}" 
                           data-price="${product.price || 0}">
                           Add To Cart
                        </a>
                    </div>
                `;

                productContainer.appendChild(productCard);
            });
            attachAddToCartListeners();
        }

        // Function to sort products
        function sortProducts(sortBy) {
            let sortedProducts = [...displayedProducts];
            if (sortBy === 'price-asc') {
                sortedProducts.sort((a, b) => (a.price || 0) - (b.price || 0));
            } else if (sortBy === 'price-desc') {
                sortedProducts.sort((a, b) => (b.price || 0) - (a.price || 0));
            } else if (sortBy === 'name-asc') {
                sortedProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            } else if (sortBy === 'name-desc') {
                sortedProducts.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
            } else if (sortBy === 'rating') {
                sortedProducts.sort((a, b) => (b['rating'] || 0) - (a['rating'] || 0));
            }
            renderProducts(sortedProducts);
        }

        // Function to attach event listeners to 'Add to Cart' buttons
        function attachAddToCartListeners() {
            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.removeEventListener('click', handleAddToCartClick);
                button.addEventListener('click', handleAddToCartClick);
            });
        }

        function handleAddToCartClick(event) {
            event.preventDefault();
            const serialNo = this.dataset.serialNo;
            const initialSize = this.dataset.size || 'N/A';
            const productUnit = this.dataset.unit;
            const productName = this.dataset.name;
            const priceString = this.dataset.price;
            const ProductPrice = parseFloat(priceString);

            console.log('--- Add to Cart Click Debug ---');
            console.log('Button Data:', this.dataset);
            console.log('Parsed ProductPrice:', ProductPrice);

            if (!isNaN(ProductPrice)) {
                console.log('Calling addToCart with:', { serialNo, quantity: 1, initialSize, productUnit, productName, ProductPrice });
                addToCart(serialNo, 1, initialSize, productUnit, productName, ProductPrice);
            } else {
                console.error("Invalid product price for Add to Cart. Received:", priceString);
                alert("Error: Could not add product to cart due to invalid price. Check console for details.");
            }
            console.log('--- End Add to Cart Click Debug ---');
        }
        
        // Function to filter products
        function filterProducts() {
            const selectedAcType = filterAcTypeSelect.value;
            const selectedAcTr = filterAcTrSelect.value;
            const selectedAcStar = filterAcStarSelect.value;
            const selectedAcInv = filterAcinvSelect.value;
            displayedProducts = allProducts.filter(product => {
                const matchesType = (selectedAcType === 'All' || product['ac_type'] === selectedAcType);
                const matchesTr = (selectedAcTr === 'All' || String(product['ac_tr']) === selectedAcTr);
                const matchesStar = (selectedAcStar === 'All' || String(product['ac_stars']) === selectedAcStar);
                const matchesInv = (selectedAcInv === 'All' || product['ac_inv'] === selectedAcInv);

                return matchesType && matchesTr && matchesStar && matchesInv;
            });

            sortProducts(sortSelect.value);
        }

        // Function to populate filter dropdowns
        function populateFilterOptions(property, selectElement) {
            const options = new Set();
            
            allProducts.forEach(product => {
                if (product[property] !== undefined && product[property] !== null) {
                    options.add(product[property]);
                }
            });

            selectElement.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = 'All';
            allOption.textContent = 'All ' + property.replace('ac_', '').replace('-', ' ');
            selectElement.appendChild(allOption);

            Array.from(options).filter(opt => opt !== 'All').sort().forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                selectElement.appendChild(option);
            });
        }

        // --- Load products from Firebase Firestore ---
        document.addEventListener('DOMContentLoaded', async () => {
            productContainer.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 20px;">Loading products...</p>';
            try {
                const querySnapshot = await getDocs(productsCollectionRef);
                querySnapshot.forEach((doc) => {
                    const productData = doc.data();
                    if (productData.type === 'AC') {
                        allProducts.push(productData);
                    }
                });

                displayedProducts = [...allProducts];

                sortProducts(sortSelect.value);

                populateFilterOptions('ac_type', filterAcTypeSelect);
                populateFilterOptions('ac_tr', filterAcTrSelect);
                populateFilterOptions('ac_stars', filterAcStarSelect);
                populateFilterOptions('ac_inv', filterAcinvSelect);
                
                sortSelect.addEventListener('change', () => {
                    sortProducts(sortSelect.value);
                });
                filterAcTypeSelect.addEventListener('change', filterProducts);
                filterAcTrSelect.addEventListener('change', filterProducts);
                filterAcStarSelect.addEventListener('change', filterProducts);
                filterAcinvSelect.addEventListener('change', filterProducts)

            } catch (error) {
                console.error("Error loading AC product data from Firestore:", error);
                const errorMessageElement = document.createElement('p');
                errorMessageElement.textContent = "Failed to load AC products. Please check your internet connection or Firebase permissions.";
                errorMessageElement.style.color = "red";
                errorMessageElement.style.textAlign = "center";
                productContainer.appendChild(errorMessageElement);
            }
        });
    </script>
</body>
</html>