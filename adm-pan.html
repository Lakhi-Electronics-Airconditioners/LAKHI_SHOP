<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakhi Airconditioners | Admin Panel</title>
    <link rel="icon" href="img/1x1-logo.png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.css">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.min.css">
    <style>
        /* Admin Panel Specific Styles */
        .admin-container {
            max-width: 1000px;
            margin: 50px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
        }

        .admin-container h1 {
            font-size: 2.5rem;
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #ff523b;
            padding-bottom: 15px;
        }

        .admin-nav {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }

        .admin-nav button {
            background-color: #f0f0f0;
            color: #555;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .admin-nav button.active,
        .admin-nav button:hover {
            background-color: #ff523b;
            color: #fff;
            border-color: #ff523b;
        }

        .admin-section {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .admin-section h2 {
            font-size: 1.8rem;
            color: #333;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="password"],
        .form-group input[type="number"],
        .form-group select { /* Added number and select input types */
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        .form-group input[type="checkbox"] {
            width: auto;
            margin-right: 5px;
        }


        .btn-admin {
            display: inline-block;
            background: #ff523b;
            color: #fff;
            padding: 10px 25px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
            border: none;
            font-size: 1rem;
            margin-top: 15px;
            margin-right: 10px;
        }

        .btn-admin:hover {
            background: #563434;
        }

        .message-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message-box.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .admin-container {
                margin: 20px auto;
                padding: 20px;
            }
            .admin-container h1 {
                font-size: 2rem;
            }
            .admin-nav {
                flex-direction: column;
                align-items: stretch;
            }
            .admin-nav button {
                margin-bottom: 10px;
            }
            .admin-section {
                padding: 15px;
            }
            .admin-section h2 {
                font-size: 1.5rem;
            }
            .btn-admin {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header-NAV">
        <div class="container">
            <div class="navbar">
                <div class="logo"><img src="img/NABR/log.jpg" width="125px" alt="Company Logo"></div>
                <nav>
                    <ul id="Menuitems">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="products.html">All Products</a></li>
                        <li><a href="contact.html">Contact Us</a></li>
                        <li><a href="account.html">Account</a></li>
                    </ul>
                </nav>
                <a href="cart.html"><img src="img/NABR/SCI.png" width="30px" alt="Shopping Cart Icon"></a>
                <img src="img/NABR/menu.png" class="menu-icon" onclick="menutoggle()" alt="Menu Icon">
            </div>
        </div>
    </div>
    <div class="color-NAV">
        <a href="#" class="back-button" onclick="history.back(); return false;">&larr; Back</a>
    </div>

    <div class="admin-container">
        <h1>Admin Panel</h1>
        <div id="loadingMessage" class="message-box">Loading...</div>
        <div id="notAdminMessage" class="message-box error hidden">Access Denied: You must be an administrator to view this page.</div>

        <!-- Password Protection Layer -->
        <div id="passwordProtection" class="admin-section">
            <h2>Admin Password Required</h2>
            <div class="form-group">
                <label for="adminPassword">Password:</label>
                <input type="password" id="adminPassword" placeholder="Enter admin password">
            </div>
            <button class="btn-admin" id="unlockPanelButton">Unlock Panel</button>
            <div id="passwordMessage" class="message-box"></div>
        </div>

        <div id="adminContent" class="hidden">
            <!-- Admin Navigation -->
            <div class="admin-nav">
                <button class="nav-button active" data-target="userManagementSection">User Management</button>
                <button class="nav-button" data-target="addProductSection">Add Product</button>
                <button class="nav-button" data-target="editProductSection">Edit Product</button>
                <button class="nav-button" data-target="makeBillSection">Make Bill</button>
                <button class="nav-button" data-target="editBillSection">Edit Bill</button>
                <button class="nav-button" data-target="accountsWithoutCustomerCodeSection">Accounts without Customer Code</button>
            </div>

            <!-- User Management Section (Existing) -->
            <div id="userManagementSection" class="admin-section">
                <h2>User Management (Read/Edit Account Info)</h2>
                <div class="form-group">
                    <label for="searchUserUid">User UID:</label>
                    <input type="text" id="searchUserUid" placeholder="Enter user's UID">
                    <small style="color:#777;">(Find UID in Firebase Authentication console)</small>
                </div>
                <button class="btn-admin" id="searchUserButton">Load User Profile</button>
                <div id="searchMessage" class="message-box"></div>

                <h3 style="margin-top: 30px;">Edit User Details</h3>
                <p><strong>Editing User ID:</strong> <span id="editingUserIdDisplay">N/A</span></p>
                <div class="form-group">
                    <label for="editName">Name:</label>
                    <input type="text" id="editName" placeholder="Full Name">
                </div>
                <div class="form-group">
                    <label for="editPhoneNumber">Phone Number:</label>
                    <input type="tel" id="editPhoneNumber" placeholder="+91-XXXXXXXXXX">
                </div>
                <div class="form-group">
                    <label for="editEmail">Email:</label>
                    <input type="email" id="editEmail" placeholder="user@example.com" disabled>
                    <small style="color:#777;">(Email cannot be changed here)</small>
                </div>
                <div class="form-group">
                    <label for="editCustomerCode">Customer Code:</label>
                    <input type="text" id="editCustomerCode" placeholder="Enter customer code">
                </div>

                <h3>Address Details</h3>
                <div class="form-group">
                    <label for="editHouseAndFlatNumber">House/Flat Number:</label>
                    <input type="text" id="editHouseAndFlatNumber" placeholder="e.g., Flat 101, Bldg A-5">
                </div>
                <div class="form-group">
                    <label for="editHousingAreaAndFlatName">Housing Area/Flat Name:</label>
                    <input type="text" id="editHousingAreaAndFlatName" placeholder="e.g., Green Valley Society, Maple Apartments">
                </div>
                <div class="form-group">
                    <label for="editAreaName">Area Name:</label>
                    <input type="text" id="editAreaName" placeholder="e.g., Satellite">
                </div>
                <div class="form-group">
                    <label for="editCity">City:</label>
                    <input type="text" id="editCity" placeholder="e.g., Ahmedabad">
                </div>
                <div class="form-group">
                    <label for="editState">State:</label>
                    <input type="text" id="editState" placeholder="e.g., Gujarat">
                </div>
                <div class="form-group">
                    <label for="editPincode">Pincode:</label>
                    <input type="text" id="editPincode" placeholder="e.g., 380015">
                </div>

                <button class="btn-admin" id="saveUserDetailsButton">Save User Details</button>
                <div id="saveMessage" class="message-box"></div>
            </div>

            <!-- Add Product Section (New) -->
            <div id="addProductSection" class="admin-section hidden">
                <h2>Add New Product</h2>
                <div class="form-group">
                    <label for="addProductName">Product Name:</label>
                    <input type="text" id="addProductName" placeholder="e.g., Voltas 1.5 Ton 3 Star Split AC" required>
                </div>
                <div class="form-group">
                    <label for="addProductSerialNo">Serial Number (Unique ID):</label>
                    <input type="text" id="addProductSerialNo" placeholder="e.g., 245V-EAZS" required>
                    <small style="color:#777;">(This will be the document ID in Firestore)</small>
                </div>
                <div class="form-group">
                    <label for="addProductPrice">Price (₹):</label>
                    <input type="number" id="addProductPrice" step="0.01" placeholder="e.g., 55000.00" required>
                </div>
                <div class="form-group">
                    <label for="addProductType">Product Type:</label>
                    <select id="addProductType" required>
                        <option value="">Select Type</option>
                        <option value="AC">AC</option>
                        <option value="Refrigerator">Refrigerator</option>
                        <option value="Washing Machine">Washing Machine</option>
                        <option value="Television">Television</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="addProductImgUrl">Image URL:</label>
                    <input type="text" id="addProductImgUrl" placeholder="e.g., https://example.com/image.jpg">
                    <small style="color:#777;">(Leave blank for placeholder image)</small>
                </div>
                <div class="form-group">
                    <label for="addProductRatingStars">Rating (0-5):</label>
                    <input type="number" id="addProductRatingStars" step="0.1" min="0" max="5" placeholder="e.g., 4.5">
                </div>
                <div class="form-group">
                    <label for="addProductRatingSource">Rating Source:</label>
                    <input type="text" id="addProductRatingSource" placeholder="e.g., Google Reviews">
                </div>
                <div class="form-group">
                    <label for="addProductRatingSourceIcon">Rating Source Icon URL:</label>
                    <input type="text" id="addProductRatingSourceIcon" placeholder="e.g., https://example.com/icon.png">
                </div>
                <div class="form-group">
                    <input type="checkbox" id="addProductHasSizeOption">
                    <label for="addProductHasSizeOption" style="display: inline;">Has Size Option (e.g., 1.5 Ton, 2 Ton)</label>
                </div>
                <div id="sizeOptionsContainer" class="hidden">
                    <p style="margin-top: 10px; font-weight: bold;">Size Options (e.g., 1.5_Ton, 2_Ton):</p>
                    <div id="sizeOptionInputs">
                        <!-- Dynamic size inputs will be added here -->
                        <div class="form-group">
                            <label>Size Key:</label>
                            <input type="text" class="size-key-input" placeholder="e.g., 1.5_Ton">
                            <label>Price:</label>
                            <input type="number" class="size-price-input" step="0.01" placeholder="e.g., 55000.00">
                            <button class="btn-admin" onclick="removeSizeOption(this)" style="background-color: #dc3545; margin-top: 0;">Remove</button>
                        </div>
                    </div>
                    <button class="btn-admin" id="addSizeOptionButton" style="background-color: #007bff;">Add Size Option</button>
                </div>

                <button class="btn-admin" id="addProductButton">Add Product</button>
                <div id="addProductMessage" class="message-box"></div>
            </div>

            <!-- Edit Product Section (Placeholder) -->
            <div id="editProductSection" class="admin-section hidden">
                <h2>Edit Existing Product</h2>
                <p>Coming soon...</p>
            </div>

            <!-- Make Bill Section (Placeholder) -->
            <div id="makeBillSection" class="admin-section hidden">
                <h2>Make New Bill / Quotation</h2>
                <p>Coming soon...</p>
            </div>

            <!-- Edit Bill Section (Placeholder) -->
            <div id="editBillSection" class="admin-section hidden">
                <h2>Edit Existing Bill / Quotation</h2>
                <p>Coming soon...</p>
            </div>

            <!-- Accounts without Customer Code Section (Placeholder) -->
            <div id="accountsWithoutCustomerCodeSection" class="admin-section hidden">
                <h2>Accounts Without Customer Code</h2>
                <p>Coming soon...</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="foot-col-1">
                    <h3>Download Our App</h3>
                    <p>Download App for Android but not <u>iphone</u> for now</p>
                    <div class="app-logo">
                        <a href="https://gonativeio-apps.s3-accelerate.amazonaws.com/static/6675cb704ad00e517ecc6016/app-release.apk?X-Amz-Algorithm=AWS4-HMz-Credential=AKIAYMYFO3A75OQPINCL%2F20250608%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20250608T094512Z&X-Amz-Expires=14400&X-Amz-Signature=b177f0359c9c7f7578365dcad89de43d06f42223b02b150ae4bb01df6fb00985&X-Amz-SignedHeaders=host"><img src="img/NABR/apk-down.jpeg" alt="Download App"></a>
                    </div>
                </div>
                <div class="foot-col-2">
                    <img src="img/log-w.png" width="200px" alt="Lakhi Airconditioners Logo">
                    <p>Our Purpose Is to give the best deal and products to the Many.</p>
                </div>
                <div class="foot-col-3">
                    <h3>Useful links</h3>
                    <ul>
                        <Li><a href="https://main.lakhiairconditioners.com/tac">Terms and Conditions</a></Li>
                        <Li><a href="https://main.lakhiairconditioners.com/pp">Privacy Policy</a></Li>
                        <li><a href="https://lakhiairconditioners.com">INFO</a></li>
                        <li><a href="https://made.lakhiairconditioners.com">VIDEOS MADE</a></li>
                    </ul>
                </div>
                <div class="foot-col-4">
                    <h3>Follow us</h3>
                    <ul>
                        <Li><a href="https://www.instagram.com/lakhi_electronic_airconditions/">Instagram</a></Li>
                        <Li><a href="https://www.facebook.com/lakhielectronicsairconditioner">Facebook</a></Li>
                    </ul>
                    <h3 style="margin-top: 20px">Contant info</h3>
                    <ul>
                        <li><a href="tel:+919825513000">+919825513000</a></li>
                        <li><a href="mailto:info@lakhiairconditioners?subject=Feedback&amp;body=Hi%20there,%20I%20have%20some%20feedback%20for%20you.">info@lakhiairconditioners.com</a></li>
                        <li><a href="https://bc.lakhiairconditioners.com">Business-card</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <p class="copyright">copyright 2025 lakhiairconditioners<br>
               all right given to fontawesome for their icons
               <a href="https://www.flaticon.com/free-icons/menu" title="menu icons">Menu icons created by ariefstudio - Flaticon</a></p>

        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import * as FirebaseAuth from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Import all auth functions
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
const firebaseConfig = {
            apiKey: "AIzaSyC-16u2n4IaGRmg88nsPmMYCGKp2jjL9Bg",
            authDomain: "lakhi-airconditioners.firebaseapp.com",
            projectId: "lakhi-airconditioners",
            storageBucket: "lakhi-airconditioners.firebasestorage.app",
            messagingSenderId: "284430318185",
            appId: "1:284430318185:web:ad09598be7a16ab46a00f8",
            measurementId: "G-LB63B1FRYC"
          };        
        const app = initializeApp(firebaseConfig);
        const auth = FirebaseAuth.getAuth(app); // Get auth instance from FirebaseAuth namespace
        const db = getFirestore(app);

        const appId = firebaseConfig.projectId;
        let currentAdminUser = null;
        let editingUserUid = null;

        // --- IMPORTANT: SET YOUR ADMIN PASSWORD HERE ---
        // !!! WARNING: This is INSECURE for production. Use a backend for real security. !!!
        const ADMIN_PANEL_PASSWORD = "admU"; // <--- CHANGE THIS TO YOUR DESIRED PASSWORD

        // UI Element References
        const loadingMessage = document.getElementById('loadingMessage');
        const notAdminMessage = document.getElementById('notAdminMessage');
        const passwordProtectionDiv = document.getElementById('passwordProtection');
        const adminPasswordInput = document.getElementById('adminPassword');
        const passwordMessageDiv = document.getElementById('passwordMessage');
        const adminContent = document.getElementById('adminContent');
        const unlockPanelButton = document.getElementById('unlockPanelButton'); // Get unlock button

        // Navigation
        const navButtons = document.querySelectorAll('.admin-nav .nav-button');
        const adminSections = document.querySelectorAll('.admin-section');

        // User Management Section
        const userManagementSection = document.getElementById('userManagementSection');
        const searchUserUidInput = document.getElementById('searchUserUid');
        const searchUserButton = document.getElementById('searchUserButton');
        const searchMessageDiv = document.getElementById('searchMessage');
        const editingUserIdDisplay = document.getElementById('editingUserIdDisplay');
        const editNameInput = document.getElementById('editName');
        const editPhoneNumberInput = document.getElementById('editPhoneNumber');
        const editEmailInput = document.getElementById('editEmail');
        const editCustomerCodeInput = document.getElementById('editCustomerCode');
        const editHouseAndFlatNumberInput = document.getElementById('editHouseAndFlatNumber');
        const editHousingAreaAndFlatNameInput = document.getElementById('editHousingAreaAndFlatName');
        const editAreaNameInput = document.getElementById('editAreaName');
        const editCityInput = document.getElementById('editCity');
        const editStateInput = document.getElementById('editState');
        const editPincodeInput = document.getElementById('editPincode');
        const saveUserDetailsButton = document.getElementById('saveUserDetailsButton');
        const saveMessageDiv = document.getElementById('saveMessage');

        // Add Product Section
        const addProductSection = document.getElementById('addProductSection');
        const addProductNameInput = document.getElementById('addProductName');
        const addProductSerialNoInput = document.getElementById('addProductSerialNo');
        const addProductPriceInput = document.getElementById('addProductPrice');
        const addProductTypeSelect = document.getElementById('addProductType');
        const addProductImgUrlInput = document.getElementById('addProductImgUrl');
        const addProductRatingStarsInput = document.getElementById('addProductRatingStars');
        const addProductRatingSourceInput = document.getElementById('addProductRatingSource');
        const addProductRatingSourceIconInput = document.getElementById('addProductRatingSourceIcon');
        const addProductHasSizeOptionCheckbox = document.getElementById('addProductHasSizeOption');
        const sizeOptionsContainer = document.getElementById('sizeOptionsContainer');
        const sizeOptionInputsContainer = document.getElementById('sizeOptionInputs');
        const addSizeOptionButton = document.getElementById('addSizeOptionButton'); // Get add size option button
        const addProductButton = document.getElementById('addProductButton');
        const addProductMessageDiv = document.getElementById('addProductMessage');


        // Menu toggle function (from your existing styles)
        const Menuitems = document.getElementById('Menuitems'); // Declared as const
        window.menutoggle = function(){ // Made globally accessible
            if(Menuitems) {
                if(Menuitems.style.maxHeight == "0px") {
                    Menuitems.style.maxHeight = "200px";
                } else {
                    Menuitems.style.maxHeight = "0px";
                }
            }
        }

        // Message display helper
        function showMessage(element, message, type = 'error') {
            element.textContent = message;
            element.className = `message-box ${type}`;
            setTimeout(() => {
                element.textContent = '';
                element.className = 'message-box'; // Reset to default
            }, 5000);
        }

        // Function to clear the edit user form
        function clearEditUserForm() {
            editingUserUid = null;
            editingUserIdDisplay.textContent = 'N/A';
            searchUserUidInput.value = ''; // Clear search input as well
            editNameInput.value = '';
            editPhoneNumberInput.value = '';
            editEmailInput.value = '';
            editCustomerCodeInput.value = '';
            editHouseAndFlatNumberInput.value = '';
            editHousingAreaAndFlatNameInput.value = '';
            editAreaNameInput.value = '';
            editCityInput.value = '';
            editStateInput.value = '';
            editPincodeInput.value = '';
            saveMessageDiv.textContent = '';
            saveMessageDiv.className = 'message-box';
            searchMessageDiv.textContent = '';
            searchMessageDiv.className = 'message-box';
        }

        // --- Admin Panel Core Logic ---

        // Check Admin Password
        function checkAdminPassword() {
            const enteredPassword = adminPasswordInput.value;
            if (enteredPassword === ADMIN_PANEL_PASSWORD) {
                passwordProtectionDiv.classList.add('hidden');
                // The admin check is now done by onAuthStateChanged.
                // If we reach here, it means the user is authenticated and recognized as admin by Firestore.
                adminContent.classList.remove('hidden');
                showMessage(passwordMessageDiv, 'Panel unlocked!', 'success');
                // Show default section (User Management)
                showSection('userManagementSection');
            } else {
                showMessage(passwordMessageDiv, 'Incorrect password.', 'error');
            }
        }
        // Attach event listener to unlock button
        if (unlockPanelButton) {
            unlockPanelButton.addEventListener('click', checkAdminPassword);
        }


        // Navigation Logic
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                navButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetId = button.dataset.target;
                showSection(targetId);
            });
        });

        function showSection(targetId) {
            adminSections.forEach(section => {
                if (section.id === targetId) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
            // Clear messages when switching sections
            passwordMessageDiv.textContent = '';
            searchMessageDiv.textContent = '';
            saveMessageDiv.textContent = '';
            addProductMessageDiv.textContent = '';
        }


        // --- User Management Functions ---

        // Search user by UID
        async function searchUserByUid() {
            const uidToSearch = searchUserUidInput.value.trim();
            if (!uidToSearch) {
                showMessage(searchMessageDiv, 'Please enter a User ID (UID).', 'error');
                return;
            }

            showMessage(searchMessageDiv, 'Searching...', 'info');
            clearEditUserForm(); // Clear previous data

            try {
                const userProfileDocRef = doc(db, `artifacts/${appId}/users/${uidToSearch}/user_profiles`, "profile");
                const docSnap = await getDoc(userProfileDocRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    editingUserUid = uidToSearch;
                    editingUserIdDisplay.textContent = uidToSearch;
                    editNameInput.value = userData.name || '';
                    editPhoneNumberInput.value = userData.phoneNumber || '';
                    editEmailInput.value = userData.email || '';
                    editCustomerCodeInput.value = userData.customerCode || '';

                    editHouseAndFlatNumberInput.value = userData.address?.houseAndFlatNumber || '';
                    editHousingAreaAndFlatNameInput.value = userData.address?.housingAreaAndFlatName || '';
                    editAreaNameInput.value = userData.address?.areaName || '';
                    editCityInput.value = userData.address?.city || '';
                    editStateInput.value = userData.address?.state || '';
                    editPincodeInput.value = userData.address?.pincode || '';

                    showMessage(searchMessageDiv, 'User profile loaded successfully!', 'success');
                } else {
                    showMessage(searchMessageDiv, `User profile not found for UID: ${uidToSearch}.`, 'error');
                }
            } catch (error) {
                console.error("Error loading user profile:", error);
                showMessage(searchMessageDiv, `Error loading profile: ${error.message}`, 'error');
            }
        }
        // Attach event listener to search button
        if (searchUserButton) {
            searchUserButton.addEventListener('click', searchUserByUid);
        }

        // Save user details to Firestore
        async function saveUserDetails() {
            if (!editingUserUid) {
                showMessage(saveMessageDiv, 'No user selected for editing. Please load a user first.', 'error');
                return;
            }

            const updatedData = {
                name: editNameInput.value.trim() || null,
                phoneNumber: editPhoneNumberInput.value.trim() || null,
                customerCode: editCustomerCodeInput.value.trim() || null,
                address: {
                    houseAndFlatNumber: editHouseAndFlatNumberInput.value.trim() || null,
                    housingAreaAndFlatName: editHousingAreaAndFlatNameInput.value.trim() || null,
                    areaName: editAreaNameInput.value.trim() || null,
                    city: editCityInput.value.trim() || null,
                    state: editStateInput.value.trim() || null,
                    pincode: editPincodeInput.value.trim() || null
                }
            };

            const existingEmail = editEmailInput.value.trim();
            const newPhoneNumber = updatedData.phoneNumber;

            if (existingEmail && !newPhoneNumber) {
                showMessage(saveMessageDiv, 'If an email is associated with the account, a phone number is required.', 'error');
                return;
            }

            const userProfileRef = doc(db, `artifacts/${appId}/users/${editingUserUid}/user_profiles`, "profile");

            try {
                await setDoc(userProfileRef, updatedData, { merge: true });
                showMessage(saveMessageDiv, 'User details saved successfully!', 'success');
                console.log("User details saved for UID:", editingUserUid, updatedData);
            } catch (error) {
                console.error("Error saving user details:", error);
                showMessage(saveMessageDiv, `Failed to save details: ${error.message}. Check Firestore rules.`, 'error');
            }
        }
        // Attach event listener to save button
        if (saveUserDetailsButton) {
            saveUserDetailsButton.addEventListener('click', saveUserDetails);
        }

        // --- Add Product Functions ---

        // Toggle size options container visibility
        addProductHasSizeOptionCheckbox.addEventListener('change', () => {
            if (addProductHasSizeOptionCheckbox.checked) {
                sizeOptionsContainer.classList.remove('hidden');
            } else {
                sizeOptionsContainer.classList.add('hidden');
                sizeOptionInputsContainer.innerHTML = ''; // Clear dynamic inputs when unchecked
                window.addSizeOption(); // Add one default empty option back using global function
            }
        });

        // Add a new size option input row
        window.addSizeOption = function() { // Made global for onclick in HTML
            const newSizeOptionDiv = document.createElement('div');
            newSizeOptionDiv.className = 'form-group';
            newSizeOptionDiv.innerHTML = `
                <label>Size Key:</label>
                <input type="text" class="size-key-input" placeholder="e.g., 1.5_Ton">
                <label>Price:</label>
                <input type="number" class="size-price-input" step="0.01" placeholder="e.g., 55000.00">
                <button class="btn-admin" onclick="removeSizeOption(this)" style="background-color: #dc3545; margin-top: 0;">Remove</button>
            `;
            sizeOptionInputsContainer.appendChild(newSizeOptionDiv);
        };
        // Attach event listener to add size option button
        if (addSizeOptionButton) {
            addSizeOptionButton.addEventListener('click', window.addSizeOption);
        }

        // Remove a size option input row
        window.removeSizeOption = function(buttonElement) { // Made global for onclick in HTML
            buttonElement.closest('.form-group').remove();
        };

        // Add Product to Firestore
        async function addNewProduct() {
            const productName = addProductNameInput.value.trim();
            const productSerialNo = addProductSerialNoInput.value.trim();
            const productPrice = parseFloat(addProductPriceInput.value);
            const productType = addProductTypeSelect.value;
            const productImgUrl = addProductImgUrlInput.value.trim() || 'https://placehold.co/300x300/cccccc/ffffff?text=Product';
            const productRatingStars = parseFloat(addProductRatingStarsInput.value) || 0;
            const productRatingSource = addProductRatingSourceInput.value.trim() || null;
            const productRatingSourceIcon = addProductRatingSourceIconInput.value.trim() || null;
            const hasSizeOption = addProductHasSizeOptionCheckbox.checked;

            if (!productName || !productSerialNo || isNaN(productPrice) || productPrice <= 0 || !productType) {
                showMessage(addProductMessageDiv, 'Please fill in all required product fields (Name, Serial No, Price, Type).', 'error');
                return;
            }

            // Check for existing serial number (Firestore document ID)
            try {
                // Correct path for products: artifacts/{appId}/public_data/products/{serial_no}
                const productDocRef = doc(db, 'artifacts', appId, 'public_data', 'products', productSerialNo);
                const docSnap = await getDoc(productDocRef);
                if (docSnap.exists()) {
                    showMessage(addProductMessageDiv, `Product with Serial Number '${productSerialNo}' already exists. Please use a unique Serial Number.`, 'error');
                    return;
                }
            } catch (error) {
                console.error("Error checking existing product:", error);
                showMessage(addProductMessageDiv, `Error checking existing product: ${error.message}`, 'error');
                return;
            }


            let priceSize = {};
            let availableSizes = [];

            if (hasSizeOption) {
                const sizeKeys = document.querySelectorAll('#sizeOptionInputs .size-key-input');
                const sizePrices = document.querySelectorAll('#sizeOptionInputs .size-price-input');

                for (let i = 0; i < sizeKeys.length; i++) {
                    const key = sizeKeys[i].value.trim();
                    const price = parseFloat(sizePrices[i].value);

                    if (key && !isNaN(price) && price > 0) {
                        priceSize[key] = price;
                        availableSizes.push(key);
                    } else if (key || !isNaN(price)) { // If one part is filled, but not valid
                        showMessage(addProductMessageDiv, 'Please ensure all size options have a valid key and price.', 'error');
                        return;
                    }
                }
                if (Object.keys(priceSize).length === 0) {
                    showMessage(addProductMessageDiv, 'You selected "Has Size Option" but did not provide any valid size options.', 'error');
                    return;
                }
            }

            const newProductData = {
                name: productName,
                serial_no: productSerialNo, // Store as a field as well
                price: productPrice, // Base price
                type: productType,
                img_url: productImgUrl,
                rating_stars: productRatingStars,
                rating_source: productRatingSource,
                rating_source_icon: productRatingSourceIcon,
                has_size_option: hasSizeOption,
                price_size: hasSizeOption ? priceSize : null,
                available_sizes: hasSizeOption ? availableSizes : null,
                createdAt: new Date().toISOString()
            };

            try {
                // Set the document with the serial_no as its ID
                // Correct path for products: artifacts/{appId}/public_data/products
                await setDoc(doc(db, 'artifacts', appId, 'public_data', 'products', productSerialNo), newProductData);
                showMessage(addProductMessageDiv, `Product '${productName}' added successfully!`, 'success');
                // Clear form
                addProductNameInput.value = '';
                addProductSerialNoInput.value = '';
                addProductPriceInput.value = '';
                addProductTypeSelect.value = '';
                addProductImgUrlInput.value = '';
                addProductRatingStarsInput.value = '';
                addProductRatingSourceInput.value = '';
                addProductRatingSourceIconInput.value = '';
                addProductHasSizeOptionCheckbox.checked = false;
                sizeOptionsContainer.classList.add('hidden');
                sizeOptionInputsContainer.innerHTML = '';
                window.addSizeOption(); // Add one default empty option back
            } catch (error) {
                console.error("Error adding product:", error);
                showMessage(addProductMessageDiv, `Failed to add product: ${error.message}. Check Firestore rules and network.`, 'error');
            }
        }
        // Attach event listener to add product button
        if (addProductButton) {
            addProductButton.addEventListener('click', addNewProduct);
        }
        // Initialize with one size option input if has_size_option is checked by default (or after reset)
        document.addEventListener('DOMContentLoaded', () => {
            if (addProductHasSizeOptionCheckbox.checked) {
                window.addSizeOption();
            } else {
                // Ensure at least one empty size option is present if checkbox is unchecked by default
                if (sizeOptionInputsContainer.children.length === 0) {
                    window.addSizeOption();
                }
            }
        });


        // --- Admin Access Check ---
        FirebaseAuth.onAuthStateChanged(auth, async (user) => { // Corrected usage
            loadingMessage.classList.add('hidden');
            if (user) {
                // Check if the user's UID exists as a document in the admin_users collection
                // Correct path: artifacts/{appId}/admin_users/{user.uid}
                const adminDocRef = doc(db, 'artifacts', appId, 'admin_users', user.uid);
                try {
                    const adminDocSnap = await getDoc(adminDocRef);
                    if (adminDocSnap.exists()) { // If the document exists, the user is an admin
                        currentAdminUser = user;
                        currentAdminUser.isAdmin = true; // Set a flag
                        passwordProtectionDiv.classList.remove('hidden');
                        notAdminMessage.classList.add('hidden');
                        showMessage(passwordMessageDiv, 'Please enter the admin panel password.', 'info');

                    } else {
                        notAdminMessage.textContent = 'Access Denied: Your account is not authorized as an administrator.';
                        notAdminMessage.classList.remove('hidden');
                        passwordProtectionDiv.classList.add('hidden');
                        adminContent.classList.add('hidden');
                        console.warn("Access Denied: User is not an admin in Firestore (document not found).");
                    }
                } catch (error) {
                    console.error("Error checking admin status:", error);
                    notAdminMessage.textContent = `Error checking admin status: ${error.message}`;
                    notAdminMessage.classList.remove('hidden');
                    passwordProtectionDiv.classList.add('hidden');
                    adminContent.classList.add('hidden');
                }
            } else {
                notAdminMessage.textContent = 'Access Denied: Please log in to an account with administrator privileges.';
                notAdminMessage.classList.remove('hidden');
                passwordProtectionDiv.classList.add('hidden');
                adminContent.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
