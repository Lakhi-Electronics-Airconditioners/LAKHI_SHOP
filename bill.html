<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="View a bill (will not work without a bill info)">
    <title>Lakhi Airconditioners | Bill Details</title>
    <link rel="icon" href="img/1x1-logo.png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.css">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* General styling for containers */
        .small-container {
            max-width: 1080px;
            margin: auto;
            padding-left: 25px;
            padding-right: 25px;
        }

        .cart-page {
            /* Adjusted top margin to fix the PDF spacing issue */
            margin: 20px auto; 
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .title {
            text-align: center;
            margin: 0 auto 30px;
            position: relative;
            line-height: 60px;
            color: #f44336; /* Red for main titles */
        }

        /* Customer Info Section */
        .customer-info {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .customer-info h3 {
            margin-bottom: 15px;
            color: #f44336; /* Red for sub-titles */
        }
        .customer-info p {
            margin-bottom: 8px;
            color: #555;
        }
        .customer-info span {
            font-weight: 600;
            color: #333;
        }

        /* Product Table */
        #productTable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        #productTable th, #productTable td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
            vertical-align: middle;
        }
        #productTable th {
            background-color: #f44336; /* Red for table headers */
            color: white;
            font-weight: 600;
        }
        #productTable tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #productTable tbody tr:hover {
            background-color: #e9e9e9;
        }
        .cart-info {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .cart-info img {
            width: 80px;
            height: 80px;
            margin-right: 10px;
            border-radius: 5px;
            object-fit: cover;
        }
        .cart-info div {
            flex: 1;
        }
        .cart-info p {
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        .cart-info small {
            color: #777;
            display: block;
            font-size: 0.8em;
        }

        /* Total Price Section */
        .total-price {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            flex-direction: column;
            align-items: flex-end;
        }
        .total-price table {
            border-top: 3px solid #f44336; /* Red border top */
            width: 100%;
            max-width: 380px;
            border-collapse: collapse;
        }
        .total-price td:first-child {
            text-align: left;
            padding: 10px 15px;
            color: #555;
        }
        .total-price td:last-child {
            text-align: right;
            padding: 10px 15px;
            font-weight: bold;
            color: #333;
        }
        .total-price tr:last-child td {
            font-size: 1.2em;
            color: #f44336; /* Red for grand total */
        }

        /* Loading/Error Messages */
        #loadingMessage, #errorMessage {
            text-align: center;
            margin-top: 50px;
            font-size: 1.2em;
            color: #777;
        }
        #errorMessage {
            color: red;
        }
        #noProductsMessage {
            text-align: center;
            color: #777;
            margin-top: 20px;
            display: none; /* Hidden by default */
        }

        /* New button and note styles */
        .btn {
            background-color: #f44336;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #d32f2f;
        }

        #billNoteContainer h4 {
            color: #333;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        #billNoteContainer p {
            font-style: italic;
            color: #555;
            line-height: 1.6;
        }

        /* Modal styles */
        .w3-modal-content {
            background-color: #fefefe;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            display: block;
        }
        
        .w3-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        /* This class will be added/removed by JavaScript */
        .hidden-modal {
            display: none;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 25px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover, .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .btn-modal {
            background-color: #f44336;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn-modal:hover {
            background-color: #d32f2f;
        }
        .w3-center { text-align: center; }
        .w3-section { margin-top: 16px !important; margin-bottom: 16px !important; }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .cart-page {
                margin: 20px auto;
                padding: 15px;
            }
            .title {
                font-size: 1.8rem !important;
            }
            #productTable th, #productTable td {
                padding: 8px 10px;
                font-size: 0.9em;
            }
            .cart-info img {
                width: 60px;
                height: 60px;
            }
            .total-price table {
                max-width: 100%;
            }
        }
    </style>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('✅ Service Worker registered'))
                .catch(err => console.error('❌ Service Worker error:', err));
        }
    </script>
</head>
<body>
    <div id="tacpp" class="w3-modal hidden-modal">
        <div class="w3-modal-content">
            <div class="w3-center" style="margin-bottom:20px;">
                <span
                    onclick="closeModal()"
                    class="close-button"
                    title="Close Modal">
                    Close ×
                </span>
                <h2>Please Agree to Proceed</h2>
            </div>
            <form class="w3-container">
                <div class="w3-section" style="margin-bottom:20px; text-align:left;">
                    <input type="checkbox" id="agree">
                    <label for="agree">
                        I agree to the
                        <a href="../info/TAC">
                            Terms and Conditions
                        </a>
                        and
                        <a href="../info/PP">
                            Privacy Policy
                        </a>.
                    </label>
                </div>
                <p style="font-size:14px; margin-bottom:20px;">
                    * Prices may not be accurate, and not all products are listed.<br>
                    *product may not be in stock or may not even be buyable anymore<br>
                    * price may go down because of some gst/cst payment things
                </p>
                <div class="w3-center">
                    <button
                        class="btn-modal"
                        onclick="continueAction(event)">
                        Continue
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="updateTacppModal" class="w3-modal hidden-modal">
        <div class="w3-modal-content">
            <div class="w3-center" style="margin-bottom:20px;">
                <span
                    onclick="closeUpdateModal()"
                    class="close-button"
                    title="Close Modal">
                    Close ×
                </span>
                <h2>Terms and Conditions Updated</h2>
            </div>
            <form class="w3-container">
                <div class="w3-section" style="margin-bottom:20px; text-align:left;">
                    <p>Our Terms and Conditions and Privacy Policy have been updated. Please review the changes and agree to continue.</p>
                    <input type="checkbox" id="agreeUpdate">
                    <label for="agreeUpdate">
                        I agree to the updated
                        <a href="../info/TAC">
                            Terms and Conditions
                        </a>
                        and
                        <a href="../info/PP">
                            Privacy Policy
                        </a>.
                    </label>
                </div>
                <div class="w3-center">
                    <button
                        class="btn-modal"
                        onclick="continueUpdateAction(event)">
                        Agree to Update
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script src="TACPP.js" defer></script>
    
    <!-- New Modal for Sign-in -->
    <div id="signInModal" class="w3-modal hidden-modal">
        <div class="w3-modal-content">
            <div class="w3-center" style="margin-bottom:20px;">
                <h2>Bill Not Found</h2>
            </div>
            <div class="w3-container">
                <p style="text-align: center; color: #555;">The bill you are trying to view does not exist. Please sign in to access your bills or check the URL.</p>
                <div class="w3-center" style="margin-top: 20px;">
                    <button class="btn-modal" onclick="window.location.href='/ls'">Sign In / Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <div class="header-NAV">
        <div class="container">
            <div class="navbar">
                <div class="logo"><img src="img/NABR/log.jpg" width="125px" alt="Company Logo"></div>
                <nav>
                    <ul id="Menuitems">
                        <li><a href="https://shop.lakhiairconditioners.com/">Home</a></li>
                        <li><a href="about">About Us</a></li>
                        <li><a href="products">All Products</a></li>
                        <li><a href="AC-only">AC Products</a></li>
                        <li><a href="contact">Contact Us</a></li>
                        <li><a href="account">Account</a></li>
                    </ul>
                </nav>
                <a href="cart"><img src="img/NABR/SCI.png" width="30px" alt="Shopping Cart Icon"></a></li>
                <img src="img/NABR/menu.png" class="menu-icon" onclick="menutoggle()" alt="Menu Icon">
            </div>
        </div>
    </div>
    <div class="color-NAV"><br><br></div>
    <div><a href="#" class="back-button" onclick="history.back(); return false;">&larr; Back</a></div>

    <div class="small-container cart-page">
        <div id="loadingMessage" class="loading-message">Loading bill details...</div>
        <div id="errorMessage" class="error-message hidden-modal"></div>

        <h1 id="billTitle" class="title" style="font-size: xx-large;"></h1>
        <br>

        <div class="customer-info">
            <h3 style="margin-bottom: 15px; color: #f44336;">bills Details</h3>
            <p><span>Customer Code:</span> <span id="customerCodeDisplay">N/A</span></p>
            <p><span>Bill Number:</span> <span id="billIdDisplay">N/A</span></p>
            <p><span>Bill Code:</span> <span id="billCodeDisplay">N/A</span></p>
            <h3 style="margin-bottom: 15px; color: #f44336;">Customer Details</h3>
            <p><span>Name:</span> <span id="customerName">N/A</span></p>
            <p><span>Address:</span> <span id="customerAddr">N/A</span></p>
            <p><span>City:</span> <span id="customerCity">N/A</span></p>
            <p><span>Pincode:</span> <span id="customerPincode">N/A</span></p>
        </div>

        <table id="productTable">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Unit</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                </tbody>
        </table>
        <p id="noProductsMessage" style="text-align: center; color: #777; margin-top: 20px; display: none;">No products found for this bill.</p>

        <!-- Bill Note Section moved here as requested -->
        <div class="row" id="billNoteContainer" style="display:none; margin-top: 20px;">
            <div class="col-12" style="text-align: left;color:#f44336">
                <br>
                <h3 style="margin-bottom: 15px; color: #f44336;">Note</h3>
                <p id="billNoteText" style="white-space: pre-wrap;color:#000000"><span></span></p>
            </div>
        </div>

        <div class="total-price">
            <table>
                <tr>
                    <td>Subtotal</td>
                    <td id="billSubtotal">₹0.00</td>
                </tr>
                <tr>
                    <td>Tax</td>
                    <td id="billTax">*(not defined)*</td>
                </tr>
                <tr>
                    <td>Total</td>
                    <td id="billGrandTotal">*(not defined)*</td>
                </tr>
            </table>
             <div style="width: 100%; text-align: right; margin-top: 15px;">
                <button id="downloadBillButton" class="btn hidden-modal">Download Bill</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="foot-col-1">
                    <h3>Download Our App</h3>
                    <p>Download App for Android but not <u>iphone</u>for now</p>
                    <div class="app-logo">
                        <a href="https://drive.google.com/uc?export=download&id=1jx18KtEjAwaQtto0XqbPWe8cz49oUuUG"><img src="img/NABR/apk-down.jpeg" alt="Download App"></a>
                    </div>
                </div>
                <div class="foot-col-2">
                    <img src="img/log-w.png" width="200px" alt="Lakhi Airconditioners Logo">
                    <p>Our Purpose Is to give the best deal and products to the Many.</p>
                </div>
                <div class="foot-col-3">
                    <h3>Useful links</h3>
                    <ul>
                        <Li><a href="https://main.lakhiairconditioners.com/TAC">Terms and Conditions</a></Li>
                        <Li><a href="https://main.lakhiairconditioners.com/PP">Privacy Policy</a></Li>
                        <li><a href="https://lakhiairconditioners.com">INFO</a></li>
                        <li><a href="https://maps.lakhiairconditioners.com">G-MAPS</a></li>
                    </ul>
                </div>
                <div class="foot-col-4">
                    <h3>Follow us</h3>
                    <ul>
                        <Li><a href="https://insta.lakhiairconditioners.com/">Instagram</a></Li>
                        <Li><a href="https://fb.lakhiairconditioners.com/">Facebook</a></Li>
                    </ul>
                    <h3 style="margin-top: 20px">Contact Info</h3>
                    <ul>
                        <li><a href="tel:+919825513000">+919825513000</a></li>
                        <li><a href="mailto:info@lakhiairconditioners?subject=Feedback&amp;body=Hi%20there,%20I%20have%20some%20feedback%20for%20you.">info@lakhiairconditioners.com</a></li>
                        <li><a href="https://bc.lakhiairconditioners.com">Business-card</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <p class="copyright">&copy; 2025 Lakhi Airconditioners. All rights reserved.<br>
                all right given to fontawesome for their icons
                <a href="https://www.flaticon.com/free-icons/menu" title="menu icons">Menu icons created by ariefstudio - Flaticon</a></p>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC-16u2n4IaGRmg88nsPmMYCGKp2jjL9Bg",
            authDomain: "lakhi-airconditioners.firebaseapp.com",
            projectId: "lakhi-airconditioners",
            storageBucket: "lakhi-airconditioners.firebasestorage.app",
            messagingSenderId: "284430318185",
            appId: "1:284430318185:web:ad09598be7a16ab46a00f8",
            measurementId: "G-LB63B1FRYC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appIdFromConfig = firebaseConfig.projectId;

        // --- Helper Functions ---
        function showMessage(element, message, type = 'error') {
            if (element) {
                element.textContent = message;
                element.classList.remove('success', 'error');
                element.classList.add(type);
                element.classList.remove('hidden-modal');
            }
        }

        function hideLoading() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) loadingMessage.classList.add('hidden-modal');
        }

        function hideAllElements() {
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const noProductsMessage = document.getElementById('noProductsMessage');
            const downloadButton = document.getElementById('downloadBillButton');
            const signInModal = document.getElementById('signInModal');

            if (loadingMessage) loadingMessage.classList.add('hidden-modal');
            if (errorMessage) errorMessage.classList.add('hidden-modal');
            if (noProductsMessage) noProductsMessage.classList.add('hidden-modal');
            if (downloadButton) downloadButton.classList.add('hidden-modal');
            if (signInModal) signInModal.classList.add('hidden-modal');
        }
        
        function generatePDF() {
            const element = document.querySelector('.cart-page');
            const customerCode = document.getElementById('customerCodeDisplay')?.textContent || 'customerscode';
            const billId = document.getElementById('billIdDisplay')?.textContent || 'billid';
            const filename = `Lakhi_Airconditioners_Bill_${customerCode}-${billId}.pdf`;

            const options = {
                // Adjusted margins to fit more content and fix top spacing
                margin: [0.2, 0.2, 0.2, 0.2], 
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(options).from(element).save();
        }

        function showSignInModal() {
            const modal = document.getElementById('signInModal');
            if (modal) {
                modal.classList.remove('hidden-modal');
            }
        }

        async function loadBillDetails() {
            hideAllElements(); 
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) loadingMessage.classList.remove('hidden-modal');

            const params = new URLSearchParams(window.location.search);
            const customerCode = params.get('customerCode');
            const billId = params.get('billId');
            const billCode = customerCode && billId ? `${customerCode}-${billId}` : 'N/A';

            let billData = null;
            let customerData = null;
            let productsToDisplay = [];
            let finalBillTitle = 'Bill Details';
            let finalSubtotal = 0;
            let finalTax = '*(not defined)*';
            let finalTotal = '*(not defined)*';
            let downloadUrl = null;
            let noteText = null;

            try {
                const customerCodeElem = document.getElementById('customerCodeDisplay');
                const billIdElem = document.getElementById('billIdDisplay');
                const errorMessage = document.getElementById('errorMessage');

                if (!customerCode || !billId) {
                    showSignInModal();
                    hideLoading();
                    return;
                }
                
                const customerDocRef = doc(db, 'artifacts', appIdFromConfig, 'customers', customerCode);
                const customerDocSnap = await getDoc(customerDocRef);
                
                if (customerDocSnap.exists()) {
                    customerData = customerDocSnap.data();
                }

                const billDocRef = doc(db, 'artifacts', appIdFromConfig, 'customers', customerCode, 'bills', billId);
                const billDocSnap = await getDoc(billDocRef);

                if (billDocSnap.exists()) {
                    billData = billDocSnap.data();
                    productsToDisplay = billData.products || [];
                    finalSubtotal = billData.billSubtotal || 0;
                    finalTax = billData.billTax || '*(not defined)*';
                    finalTotal = billData.billTotal || '*(not defined)*';
                    downloadUrl = billData.url || null;
                    noteText = billData.note || null;

                    if (billData.title === "C" && billData.Cname) {
                        finalBillTitle = billData.Cname;
                    } else if (billData.type === 1) {
                        finalBillTitle = "Invoice #" + billId;
                    } else if (billData.type === 2) {
                        finalBillTitle = "Quotation #" + billId;
                    } else {
                        finalBillTitle = "Bill Details #" + billId;
                    }
                } else {
                    showSignInModal();
                    hideLoading();
                    return;
                }

                const downloadButton = document.getElementById('downloadBillButton');
                if (downloadButton) {
                    downloadButton.classList.remove('hidden-modal');
                    if (downloadUrl) {
                        downloadButton.onclick = () => {
                            window.open(downloadUrl, '_blank');
                        };
                    } else {
                        downloadButton.onclick = generatePDF;
                    }
                }

                const billNoteContainer = document.getElementById('billNoteContainer');
                const billNoteText = document.getElementById('billNoteText');
                if (billNoteContainer && billNoteText) {
                    if (noteText && noteText.trim() !== '') {
                        billNoteText.textContent = noteText;
                        billNoteContainer.style.display = 'block';
                    } else {
                        billNoteContainer.style.display = 'none';
                    }
                }

                const billTitleElem = document.getElementById('billTitle');
                if (billTitleElem) billTitleElem.textContent = finalBillTitle;

                const customerNameElem = document.getElementById('customerName');
                const customerAddrElem = document.getElementById('customerAddr');
                const customerCityElem = document.getElementById('customerCity');
                const customerPincodeElem = document.getElementById('customerPincode');
                const billCodeElem = document.getElementById('billCodeDisplay');

                if (customerData) {
                    if (customerNameElem) customerNameElem.textContent = customerData.NAME || 'N/A';
                    if (customerAddrElem) {
                        if (Array.isArray(customerData.addr) && customerData.addr.length > 0) {
                            customerAddrElem.textContent = customerData.addr
                                .map(part => typeof part === 'string' ? part.trim() : JSON.stringify(part))
                                .filter(part => part !== '')
                                .join(', ') || 'N/A';
                        } else {
                            customerAddrElem.textContent = 'N/A';
                        }
                    }
                    if (customerCityElem) customerCityElem.textContent = customerData.ct || 'N/A';
                    if (customerPincodeElem) customerPincodeElem.textContent = customerData.pincode || 'N/A';
                } else {
                    if (customerNameElem) customerNameElem.textContent = 'N/A';
                    if (customerAddrElem) customerAddrElem.textContent = 'N/A';
                    if (customerCityElem) customerCityElem.textContent = 'N/A';
                    if (customerPincodeElem) customerPincodeElem.textContent = 'N/A';
                }

                if (customerCodeElem) customerCodeElem.textContent = customerCode || 'N/A';
                if (billIdElem) billIdElem.textContent = billId || 'N/A';
                if (billCodeElem) billCodeElem.textContent = billCode;

                const productTableBody = document.getElementById('productTableBody');
                const noProductsMessage = document.getElementById('noProductsMessage');

                if (productTableBody) productTableBody.innerHTML = '';
                if (productsToDisplay.length > 0) {
                    for (const product of productsToDisplay) {
                        const finalProductName = product.name || 'N/A Product';
                        const finalProductSR = product.SR || null;
                        
                        // New logic: Check for image_url, then try SR, then use default
                        const finalProductImage = product.image_url || (finalProductSR ? `img/PROC/${finalProductSR}.jpg` : 'img/PROC/DP.gif');

                        const qty = parseInt(product.quantity || product.qty, 10) || 1;

                        // Use the price from the bill data
                        const finalProductPrice = isNaN(parseFloat(product.price)) ? 0 : parseFloat(product.price);
                        const itemTotal = finalProductPrice * qty;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="cart-info">
                                    <img src="${finalProductImage}" alt="${finalProductName}" style="display: flex;justify-content: center;align-items: center;width: 80px;height: 80px;margin-right: 10px;border-radius: 5px;object-fit: cover;">
                                    <div>
                                        <small>PN/SR: ${finalProductSR || 'N/A'}</small>
                                        <p>${finalProductName}</p>
                                        <small>Price: ₹${finalProductPrice.toFixed(2)}</small>
                                    </div>
                                </div>
                            </td>
                            <td>${qty} unit</td>
                            <td>₹${itemTotal.toFixed(2)}</td>
                        `;
                        productTableBody.appendChild(row);
                    }
                    if (noProductsMessage) noProductsMessage.style.display = 'none';
                } else {
                    if (noProductsMessage) noProductsMessage.style.display = 'block';
                }

                const billSubtotalElem = document.getElementById('billSubtotal');
                const billTaxElem = document.getElementById('billTax');
                const billGrandTotalElem = document.getElementById('billGrandTotal');

                if (billSubtotalElem) billSubtotalElem.textContent = `₹${parseFloat(finalSubtotal).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                if (billTaxElem) billTaxElem.textContent = finalTax;
                if (billGrandTotalElem) billGrandTotalElem.textContent = finalTotal;

            } catch (error) {
                console.error("Error loading bill details:", error);
                const billTitleElem = document.getElementById('billTitle');
                if (billTitleElem) billTitleElem.textContent = 'Error Loading Bill';
                showSignInModal();
            } finally {
                hideLoading();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadBillDetails();
        });

        var Menuitems = document.getElementById("Menuitems");
        if (Menuitems) {
            Menuitems.style.maxHeight = "0px";
            window.menutoggle = function() {
                if (Menuitems.style.maxHeight == "0px") {
                    Menuitems.style.maxHeight = "200px";
                } else {
                    Menuitems.style.maxHeight = "0px";
                }
            };
        } else {
            console.warn("Menuitems element not found for mobile toggle.");
        }
    </script>
</body>
</html>
