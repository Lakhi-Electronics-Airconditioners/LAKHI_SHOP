<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Veiw a bill (will not work without a bill info)">
    <title>Lakhi Airconditioners | Bill Details</title>
    <!-- Favicon -->
    <link rel="icon" href="img/1x1-logo.png">
    <!-- Main stylesheet -->
    <link rel="stylesheet" href="styles.css">
    <!-- Poppins font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.css">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.min.css">
    <style>
        /* General styling for containers */
        .small-container {
            max-width: 1080px;
            margin: auto;
            padding-left: 25px;
            padding-right: 25px;
        }

        .cart-page {
            margin: 80px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .title {
            text-align: center;
            margin: 0 auto 30px;
            position: relative;
            line-height: 60px;
            color: #f44336; /* Red for main titles */
        }

        /* Customer Info Section */
        .customer-info {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .customer-info h3 {
            margin-bottom: 15px;
            color: #f44336; /* Red for sub-titles */
        }
        .customer-info p {
            margin-bottom: 8px;
            color: #555;
        }
        .customer-info span {
            font-weight: 600;
            color: #333;
        }

        /* Product Table */
        #productTable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        #productTable th, #productTable td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
            vertical-align: middle;
        }
        #productTable th {
            background-color: #f44336; /* Red for table headers */
            color: white;
            font-weight: 600;
        }
        #productTable tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #productTable tbody tr:hover {
            background-color: #e9e9e9;
        }
        .cart-info {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .cart-info img {
            width: 80px;
            height: 80px;
            margin-right: 10px;
            border-radius: 5px;
            object-fit: cover;
        }
        .cart-info div {
            flex: 1;
        }
        .cart-info p {
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        .cart-info small {
            color: #777;
            display: block;
            font-size: 0.8em;
        }

        /* Total Price Section */
        .total-price {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .total-price table {
            border-top: 3px solid #f44336; /* Red border top */
            width: 100%;
            max-width: 380px;
            border-collapse: collapse;
        }
        .total-price td:first-child {
            text-align: left;
            padding: 10px 15px;
            color: #555;
        }
        .total-price td:last-child {
            text-align: right;
            padding: 10px 15px;
            font-weight: bold;
            color: #333;
        }
        .total-price tr:last-child td {
            font-size: 1.2em;
            color: #f44336; /* Red for grand total */
        }

        /* Loading/Error Messages */
        #loadingMessage, #errorMessage {
            text-align: center;
            margin-top: 50px;
            font-size: 1.2em;
            color: #777;
        }
        #errorMessage {
            color: red;
        }
        #noProductsMessage {
            text-align: center;
            color: #777;
            margin-top: 20px;
            display: none; /* Hidden by default */
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .cart-page {
                margin: 20px auto;
                padding: 15px;
            }
            .title {
                font-size: 1.8rem !important;
            }
            #productTable th, #productTable td {
                padding: 8px 10px;
                font-size: 0.9em;
            }
            .cart-info img {
                width: 60px;
                height: 60px;
            }
            .total-price table {
                max-width: 100%;
            }
        }
    </style>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('✅ Service Worker registered'))
                .catch(err => console.error('❌ Service Worker error:', err));
        }
    </script>
</head>
<body>
    <!-- Terms and Conditions Modal (Initial Agreement) -->
    <div id="tacpp" class="w3-modal-content">
        <div class="w3-center" style="margin-bottom:20px;">
            <span 
                onclick="closeModal()" 
                class="close-button" 
                title="Close Modal">
                Close ×
            </span>
            <h2>Please Agree to Proceed</h2>
        </div>
        <form class="w3-container">
            <!-- Agreement Checkbox -->
            <div class="w3-section" style="margin-bottom:20px; text-align:left;">
                <input type="checkbox" id="agree">
                <label for="agree">
                    I agree to the 
                    <a href="../info/TAC">
                        Terms and Conditions
                    </a> 
                    and 
                    <a href="../info/PP">
                        Privacy Policy
                    </a>.
                </label>
            </div>
            <!-- Disclaimer Section -->
            <p style="font-size:14px; margin-bottom:20px;">
                * Prices may not be accurate, and not all products are listed.<br>
                *product may not be in stock or may not even be buyable anymore<br>
                * price may go down because of some gst/cst payment things
            </p>
            <!-- Continue Button -->
            <div class="w3-center">
                <button 
                    class="btn-modal" 
                    onclick="continueAction(event)">
                    Continue
                </button>
            </div>
        </form>
    </div>

    <!-- Terms and Conditions Update Modal -->
    <div id="updateTacppModal" class="w3-modal-content">
        <div class="w3-center" style="margin-bottom:20px;">
            <span 
                onclick="closeUpdateModal()" 
                class="close-button" 
                title="Close Modal">
                Close ×
            </span>
            <h2>Terms and Conditions Updated</h2>
        </div>
        <form class="w3-container">
            <!-- Update Agreement Checkbox -->
            <div class="w3-section" style="margin-bottom:20px; text-align:left;">
                <p>Our Terms and Conditions and Privacy Policy have been updated. Please review the changes and agree to continue.</p>
                <input type="checkbox" id="agreeUpdate">
                <label for="agreeUpdate">
                    I agree to the updated 
                    <a href="../info/TAC">
                        Terms and Conditions
                    </a> 
                    and 
                    <a href="../info/PP">
                        Privacy Policy
                    </a>.
                </label>
            </div>
            <!-- Continue Button for Update -->
            <div class="w3-center">
                <button 
                    class="btn-modal" 
                    onclick="continueUpdateAction(event)">
                    Agree to Update
                </button>
            </div>
        </form>
    </div>
    <script src="TACPP.js" defer></script>
    <!-- Header Navigation -->
    <div class="header-NAV">
        <div class="container">
            <div class="navbar">
                <div class="logo"><img src="img/NABR/log.jpg" width="125px" alt="Company Logo"></div>
                <nav>
                    <ul id="Menuitems">
                        <li><a href="https://shop.lakhiairconditioners.com/">Home</a></li>
                        <li><a href="about">About Us</a></li>
                        <li><a href="products">All Products</a></li>
                        <li><a href="AC-only">AC Products</a></li>
                        <li><a href="contact">Contact Us</a></li>
                        <li><a href="account">Account</a></li>
                        
                    </ul>
                </nav>
                <li><a href="cart"><img src="img/NABR/SCI.png" width="30px" alt="Shopping Cart Icon"></a></li>
                <img src="img/NABR/menu.png" class="menu-icon" onclick="menutoggle()" alt="Menu Icon">
            </div>
        </div>
    </div>
    <div class="color-NAV"><br><br></div>
    <div><a href="#" class="back-button" onclick="history.back(); return false;">&larr; Back</a></div>

    <!-- Main content area -->
    <div class="small-container cart-page">
        <div id="loadingMessage" class="loading-message">Loading bill details...</div>
        <div id="errorMessage" class="error-message hidden"></div>

        <!-- Bill Title -->
        <h1 id="billTitle" class="title" style="font-size: xx-large;"></h1>
        <br>

        <!-- Customer Details Section -->
        <div class="customer-info">
            <h3 style="margin-bottom: 15px; color: #f44336;">Customer Details</h3>
            <p><span>Name:</span> <span id="customerName">N/A</span></p>
            <p><span>Address:</span> <span id="customerAddr">N/A</span></p>
            <p><span>City:</span> <span id="customerCity">N/A</span></p>
            <p><span>Pincode:</span> <span id="customerPincode">N/A</span></p>
        </div>

        <!-- Product Details Table -->
        <table id="productTable">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Unit</th>
                    <th>Subtotal</th>
                    <th>Action</th> <!-- Placeholder for consistency with cart.html -->
                </tr>
            </thead>
            <tbody id="productTableBody">
                <!-- Product rows will be inserted here by JavaScript -->
            </tbody>
        </table>
        <p id="noProductsMessage" style="text-align: center; color: #777; margin-top: 20px; display: none;">No products found for this bill.</p>

        <!-- Total Price section -->
        <div class="total-price">
            <table>
                <tr>
                    <td>Subtotal</td>
                    <td id="billSubtotal">₹0.00</td>
                </tr>
                <tr>
                    <td>Tax</td>
                    <td id="billTax">*GET TOTAL BY CONTACTING US*</td>
                </tr>
                <tr>
                    <td>Total</td>
                    <td id="billGrandTotal">*GET TOTAL BY CONTACTING US*</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="foot-col-1">
                    <h3>Download Our App</h3>
                    <p>Download App for Android but not <u>iphone</u>for now</p>
                    <div class="app-logo">
                        <a href="https://drive.google.com/uc?export=download&id=1jx18KtEjAwaQtto0XqbPWe8cz49oUuUG"><img src="img/NABR/apk-down.jpeg" alt="Download App"></a>
                    </div>
                </div>
                <div class="foot-col-2">
                    <img src="img/log-w.png" width="200px" alt="Lakhi Airconditioners Logo">
                    <p>Our Purpose Is to give the best deal and products to the Many.</p>
                </div>
                <div class="foot-col-3">
                    <h3>Useful links</h3>
                    <ul>
                        <Li><a href="https://main.lakhiairconditioners.com/TAC">Terms and Conditions</a></Li>
                        <Li><a href="https://main.lakhiairconditioners.com/PP">Privacy Policy</a></Li>
                        <li><a href="https://lakhiairconditioners.com">INFO</a></li>
                        <li><a href="https://maps.lakhiairconditioners.com">G-MAPS</a></li>
                    </ul>
                </div>
                <div class="foot-col-4">
                    <h3>Follow us</h3>
                    <ul>
                        <Li><a href="https://insta.lakhiairconditioners.com/">Instagram</a></Li>
                        <Li><a href="https://fb.lakhiairconditioners.com/">Facebook</a></Li>
                    </ul>
                    <h3 style="margin-top: 20px">Contact Info</h3>
                    <ul>
                        <li><a href="tel:+919825513000">+919825513000</a></li>
                        <li><a href="mailto:info@lakhiairconditioners?subject=Feedback&amp;body=Hi%20there,%20I%20have%20some%20feedback%20for%20you.">info@lakhiairconditioners.com</a></li>
                        <li><a href="https://bc.lakhiairconditioners.com">Business-card</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <p class="copyright">&copy; 2025 Lakhi Airconditioners. All rights reserved.<br>
                all right given to fontawesome for their icons
                <a href="https://www.flaticon.com/free-icons/menu" title="menu icons">Menu icons created by ariefstudio - Flaticon</a></p>

        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC-16u2n4IaGRmg88nsPmMYCGKp2jjL9Bg",
            authDomain: "lakhi-airconditioners.firebaseapp.com",
            projectId: "lakhi-airconditioners",
            storageBucket: "lakhi-airconditioners.firebasestorage.app",
            messagingSenderId: "284430318185",
            appId: "1:284430318185:web:ad09598be7a16ab46a00f8",
            measurementId: "G-LB63B1FRYC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appIdFromConfig = firebaseConfig.projectId;

        // --- Helper Functions (Moved to global scope) ---
        function showMessage(element, message, type = 'error') {
            if (element) {
                element.textContent = message;
                element.classList.remove('success', 'error');
                element.classList.add(type);
                element.classList.remove('hidden');
            }
        }

        function hideLoading() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) loadingMessage.classList.add('hidden');
        }

        function hideMessages() {
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const noProductsMessage = document.getElementById('noProductsMessage');

            if (loadingMessage) loadingMessage.classList.add('hidden');
            if (errorMessage) errorMessage.classList.add('hidden');
            if (noProductsMessage) noProductsMessage.classList.add('hidden');
        }

        async function loadBillDetails(user) {
            hideMessages();
            const loadingMessage = document.getElementById('loadingMessage'); // Re-get inside function for safety
            if (loadingMessage) loadingMessage.classList.remove('hidden');

            const params = new URLSearchParams(window.location.search);
            const customerCode = params.get('customerCode');
            const billId = params.get('billId');

            // Dynamic bill details from URL parameters (prioritize these)
            const dynamicProductsParam = params.get('products');
            const dynamicSubtotal = params.get('subtotal');
            const dynamicTax = params.get('tax');
            const dynamicTotal = params.get('total');
            const dynamicType = params.get('type');
            const dynamicInfo = params.get('info'); // This is the custom title

            let billData = null;
            let customerData = null;
            let productsToDisplay = [];
            let finalBillTitle = 'Bill Details';
            let finalSubtotal = 0;
            let finalTax = '*GET TOTAL BY CONTACTING US*';
            let finalTotal = '*GET TOTAL BY CONTACTING US*';

            try {
                // Check if user is authenticated and not anonymous
                if (!user || user.isAnonymous) {
                    const currentUrl = encodeURIComponent(window.location.href);
                    // Redirect to login page, passing the current bill URL as a redirect parameter
                    window.location.href = `account.html?redirect=${currentUrl}&message=${encodeURIComponent('Please sign in to view this bill.')}`;
                    return; // Stop execution
                }

                // --- Fetch Customer Data ---
                const customerNameElem = document.getElementById('customerName');
                const customerAddrElem = document.getElementById('customerAddr');
                const customerCityElem = document.getElementById('customerCity');
                const customerPincodeElem = document.getElementById('customerPincode');
                const errorMessage = document.getElementById('errorMessage'); // Re-get for local scope

                if (customerCode) {
                    const customerDocRef = doc(db, 'artifacts', appIdFromConfig, 'customers', customerCode);
                    const customerDocSnap = await getDoc(customerDocRef);
                    if (customerDocSnap.exists()) {
                        customerData = customerDocSnap.data();
                        console.log("Fetched customer data from Firebase:", customerData);
                    } else {
                        console.warn(`Customer with code ${customerCode} not found in Firestore.`);
                    }
                }

                // If customer data not found in Firebase, or if dynamic customer details are provided, use them
                if (!customerData && params.get('customerName')) {
                    customerData = {
                        NAME: params.get('customerName') || 'N/A',
                        addr: params.get('customerAddr1') ? [params.get('customerAddr1')] : [],
                        ct: params.get('customerCt') || 'N/A',
                        pincode: params.get('customerPincode') || 'N/A'
                    };
                    console.log("Using dynamic customer data from URL:", customerData);
                } else if (!customerCode && !params.get('customerName')) {
                    showMessage(errorMessage, 'No customer details provided in URL or Firebase.', 'error');
                    const billTitleElem = document.getElementById('billTitle');
                    if (billTitleElem) billTitleElem.textContent = 'Error Loading Bill';
                    hideLoading();
                    return;
                }

                // --- Fetch Bill Data from Firestore (if not dynamic products are explicitly passed) ---
                if (customerCode && billId && !dynamicProductsParam) {
                    const billDocRef = doc(db, 'artifacts', appIdFromConfig, 'customers', customerCode, 'bills', billId);
                    const billDocSnap = await getDoc(billDocRef);
                    if (billDocSnap.exists()) {
                        billData = billDocSnap.data();
                        console.log("Fetched bill data from Firebase:", billData);
                        productsToDisplay = billData.products || [];
                        finalSubtotal = billData.billSubtotal || 0;
                        finalTax = billData.billTax || '*GET TOTAL BY CONTACTING US*';
                        finalTotal = billData.billTotal || '*GET TOTAL BY CONTACTING US*';
                        
                        // Set bill title from Firebase data
                        if (billData.title === "C" && billData.Cname) {
                            finalBillTitle = billData.Cname;
                        } else if (billData.type === 1) {
                            finalBillTitle = "Invoice #" + billId;
                        } else if (billData.type === 2) {
                            finalBillTitle = "Quotation #" + billId;
                        } else {
                            finalBillTitle = "Bill Details #" + billId;
                        }
                    } else {
                        console.warn(`Bill with ID ${billId} for customer ${customerCode} not found in Firestore.`);
                        showMessage(errorMessage, `Bill "${billId}" for customer "${customerCode}" not found.`, 'error');
                        const billTitleElem = document.getElementById('billTitle');
                        if (billTitleElem) billTitleElem.textContent = 'Bill Not Found';
                        hideLoading();
                        return;
                    }
                }

                // --- Override/Supplement with Dynamic URL Parameters (always take precedence) ---
                if (dynamicProductsParam) {
                    try {
                        productsToDisplay = dynamicProductsParam.split('||').map(productStr => {
                            const parts = new URLSearchParams(productStr);
                            const type = parts.get('type');
                            if (type === 'SR') {
                                return {
                                    SR: parts.get('sr'),
                                    qty: parseInt(parts.get('qty'), 10),
                                    price: parseFloat(parts.get('price')) || undefined // Price from URL for SR product
                                };
                            } else if (type === 'DIRECT') {
                                return {
                                    name: parts.get('name'),
                                    price: parseFloat(parts.get('price')),
                                    qty: parseInt(parts.get('qty'), 10),
                                    SR: parts.get('sr_opt') || 'N/A'
                                };
                            }
                            return null;
                        }).filter(p => p !== null);

                        // Recalculate subtotal from dynamic products if they are present
                        finalSubtotal = productsToDisplay.reduce((sum, p) => {
                            const price = parseFloat(p.price) || 0; // Use price from dynamic product data
                            const qty = parseInt(p.qty, 10) || 0;
                            return sum + (price * qty);
                        }, 0);

                    } catch (e) {
                        console.error("Error parsing dynamic products from URL:", e);
                        showMessage(errorMessage, "Error loading dynamic product data from URL.", 'error');
                        productsToDisplay = []; // Clear products if parsing fails
                    }
                }

                // Override financial totals if dynamic parameters are present
                if (dynamicSubtotal) finalSubtotal = parseFloat(dynamicSubtotal);
                if (dynamicTax) finalTax = dynamicTax;
                if (dynamicTotal) finalTotal = dynamicTotal;
                
                // Override bill title/type if dynamic parameters are present
                if (dynamicInfo) { // 'info' parameter from bu.html is for custom title
                    finalBillTitle = dynamicInfo;
                } else if (dynamicType) {
                    const typeNum = parseInt(dynamicType, 10);
                    if (typeNum === 1) finalBillTitle = 'Invoice';
                    else if (typeNum === 2) finalBillTitle = 'Quotation';
                    else finalBillTitle = `Type ${dynamicType}`;
                }


                // --- Populate HTML ---
                const billTitleElem = document.getElementById('billTitle'); // Re-get for local scope
                if (billTitleElem) billTitleElem.textContent = finalBillTitle;

                if (customerData) {
                    if (customerNameElem) customerNameElem.textContent = customerData.NAME || 'N/A';
                    if (customerAddrElem) {
                        if (Array.isArray(customerData.addr) && customerData.addr.length > 0) {
                            // Robustly convert each part to string, handle potential objects
                            customerAddrElem.textContent = customerData.addr
                                .map(part => {
                                    if (typeof part === 'string') return part.trim();
                                    if (typeof part === 'object' && part !== null) return JSON.stringify(part); // Stringify objects
                                    return ''; // Fallback for other types
                                })
                                .filter(part => part !== '')
                                .join(', ') || 'N/A';
                        } else {
                            customerAddrElem.textContent = 'N/A';
                        }
                    }
                    if (customerCityElem) customerCityElem.textContent = customerData.ct || 'N/A';
                    if (customerPincodeElem) customerPincodeElem.textContent = customerData.pincode || 'N/A';
                } else {
                    if (customerNameElem) customerNameElem.textContent = 'N/A';
                    if (customerAddrElem) customerAddrElem.textContent = 'N/A';
                    if (customerCityElem) customerCityElem.textContent = 'N/A';
                    if (customerPincodeElem) customerPincodeElem.textContent = 'N/A';
                }

                const productTableBody = document.getElementById('productTableBody'); // Re-get for local scope
                const noProductsMessage = document.getElementById('noProductsMessage'); // Re-get for local scope

                if (productTableBody) productTableBody.innerHTML = ''; // Clear existing rows
                if (productsToDisplay.length > 0) {
                    for (const product of productsToDisplay) {
                        let finalProductName = product.name || 'N/A Product';
                        let finalProductPrice = parseFloat(product.price); // Price from bill data or dynamic URL
                        let finalProductSR = product.SR || 'N/A';

                        // If price from bill data is not valid, try to fetch from products collection
                        if (isNaN(finalProductPrice) && finalProductSR !== 'N/A') {
                            try {
                                const productsCollectionRef = collection(db, "artifacts", appIdFromConfig, "products");
                                const q = query(productsCollectionRef, where("serial_no", "==", finalProductSR));
                                const querySnapshot = await getDocs(q);

                                if (!querySnapshot.empty) {
                                    const fetchedProduct = querySnapshot.docs[0].data();
                                    finalProductName = fetchedProduct.name || finalProductName;
                                    if (fetchedProduct.price && !isNaN(parseFloat(fetchedProduct.price))) {
                                        finalProductPrice = parseFloat(fetchedProduct.price);
                                    }
                                } else {
                                    console.warn(`Product with serial_no "${finalProductSR}" not found in products collection. Displaying data from bill.`);
                                }
                            } catch (prodError) {
                                console.error(`Error querying product by serial_no "${finalProductSR}":`, prodError);
                            }
                        }
                        
                        // Ensure finalProductPrice is a number, default to 0 if still NaN
                        finalProductPrice = isNaN(finalProductPrice) ? 0 : finalProductPrice;

                        const qty = parseInt(product.quantity || product.qty, 10) || 1;
                        const itemTotal = finalProductPrice * qty;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="cart-info">
                                    <img src="https://placehold.co/80x80/cccccc/ffffff?text=Product" alt="${finalProductName}">
                                    <div>
                                        <small>PN/SR: ${finalProductSR}</small>
                                        <p>${finalProductName}</p>
                                        <small>Price: ₹${finalProductPrice.toFixed(2)}</small>
                                    </div>
                                </div>
                            </td>
                            <td>${qty} unit</td>
                            <td>₹${itemTotal.toFixed(2)}</td>
                            <td></td> <!-- Action column, empty for bill view -->
                        `;
                        productTableBody.appendChild(row);
                    }
                    if (noProductsMessage) noProductsMessage.style.display = 'none';
                } else {
                    if (noProductsMessage) noProductsMessage.style.display = 'block';
                }

                const billSubtotalElem = document.getElementById('billSubtotal'); // Re-get for local scope
                const billTaxElem = document.getElementById('billTax'); // Re-get for local scope
                const billGrandTotalElem = document.getElementById('billGrandTotal'); // Re-get for local scope

                if (billSubtotalElem) billSubtotalElem.textContent = `₹${parseFloat(finalSubtotal).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                if (billTaxElem) billTaxElem.textContent = finalTax;
                if (billGrandTotalElem) billGrandTotalElem.textContent = finalTotal;

            } catch (error) {
                console.error("Error loading bill details:", error);
                showMessage(errorMessage, `Failed to load bill: ${error.message}. Check console for details.`, 'error');
                const billTitleElem = document.getElementById('billTitle');
                if (billTitleElem) billTitleElem.textContent = 'Error Loading Bill';
            } finally {
                hideLoading();
            }
        }

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Use onAuthStateChanged to ensure Firebase Auth is ready and check user status
            onAuthStateChanged(auth, (user) => {
                loadBillDetails(user); // Pass the user object to loadBillDetails
            });
        });

        // Mobile menu toggle (from your original HTML)
        var Menuitems = document.getElementById("Menuitems");
        if (Menuitems) {
            Menuitems.style.maxHeight = "0px";
            window.menutoggle = function() { // Make it a global function
                if (Menuitems.style.maxHeight == "0px") {
                    Menuitems.style.maxHeight = "200px";
                } else {
                    Menuitems.style.maxHeight = "0px";
                }
            };
        } else {
            console.warn("Menuitems element not found for mobile toggle.");
        }
    </script>
</body>
</html>
