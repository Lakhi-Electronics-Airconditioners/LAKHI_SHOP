<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakhi Airconditioners | Bill Details</title>
    <!-- Favicon -->
    <link rel="icon" href="img/1x1-logo.png">
    <!-- Main stylesheet -->
    <link rel="stylesheet" href="styles.css">
    <!-- Poppins font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.css">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.min.css">
</head>
<body>
    <!-- Header Navigation -->
    <div class="header-NAV">
        <div class="container">
            <div class="navbar">
                <div class="logo"><img src="img/NABR/log.jpg" width="125px" alt="Company Logo"></div>
                <nav>
                    <ul id="Menuitems">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="products.html">All Products</a></li>
                        <li><a href="contact.html">Contact Us</a></li>
                        <li><a href="account.html">Account</a></li>
                        <li><a href="cart.html"><img src="img/NABR/SCI.png" width="30px" alt="Shopping Cart Icon"></a></li>
                    </ul>
                </nav>
                <img src="img/NABR/menu.png" class="menu-icon" onclick="menutoggle()" alt="Menu Icon">
            </div>
        </div>
    </div>
    <div class="color-NAV"><br><br></div>
    <div><a href="#" class="back-button" onclick="history.back(); return false;">&larr; Back</a></div>

    <!-- Main content area -->
    <div class="small-container cart-page">
        <!-- Bill Title -->
        <h1 id="billTitle" class="title" style="font-size: xx-large;">Loading Bill...</h1>
        <br>

        <!-- Customer Details Section -->
        <div class="customer-info" style="margin-bottom: 30px; padding: 20px; border: 1px solid #eee; border-radius: 8px; background-color: #f9f9f9;">
            <h3 style="margin-bottom: 15px; color: #333;">Customer Details</h3>
            <p><span>Name:</span> <span id="customerName">N/A</span></p>
            <p><span>Address:</span> <span id="customerAddr1">N/A</span></p>
            <p><span>City:</span> <span id="customerCt">N/A</span></p>
            <p><span>Pincode:</span> <span id="customerPincode">N/A</span></p>
        </div>

        <!-- Product Details Table -->
        <table id="productTable">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Unit</th>
                    <th>Subtotal</th>
                    <th>Action</th> <!-- Placeholder for consistency with cart.html -->
                </tr>
            </thead>
            <tbody id="productTableBody">
                <!-- Product rows will be inserted here by JavaScript -->
            </tbody>
        </table>
        <p id="noProductsMessage" style="text-align: center; color: #777; margin-top: 20px; display: none;">No products found for this bill.</p>

        <!-- Total Price section -->
        <div class="total-price">
            <table>
                <tr>
                    <td>Subtotal</td>
                    <td id="billSubtotal">₹0.00</td>
                </tr>
                <tr>
                    <td>Tax</td>
                    <td id="billTax">*GET TOTAL BY CONTACTING US*</td>
                </tr>
                <tr>
                    <td>Total</td>
                    <td id="billGrandTotal">*GET TOTAL BY CONTACTING US*</td>
                </tr>
            </table>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="foot-col-1">
                    <h3>Download Our App</h3>
                    <p>Download App for Android but not <u>iphone</u>for now</p>
                    <div class="app-logo">
                        <a href="https://gonativeio-apps.s3-accelerate.amazonaws.com/static/6675cb704ad00e517ecc6016/app-release.apk?X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=AKIAYMYFO3A75OQPINCL%2F20250608%2Fus-east-1%2Fs3%2Faws4_request&X-Amz-Date=20250608T094512Z&X-Amz-Signature=b177f0359c9c7f7578365dcad89de43d06f42223b02b150ae4bb01df6fb00985&X-Amz-SignedHeaders=host"><img src="img/NABR/apk-down.jpeg" alt="Download App"></a>
                    </div>
                </div>
                <div class="foot-col-2">
                    <img src="img/log-w.png" width="200px" alt="Lakhi Airconditioners Logo">
                    <p>Our Purpose Is to give the best deal and products to the Many.</p>
                </div>
                <div class="foot-col-3">
                    <h3>Useful links</h3>
                    <ul>
                        <Li><a href="https://main.lakhiairconditioners.com/TAC">Terms and Conditions</a></Li>
                        <Li><a href="https://main.lakhiairconditioners.com/PP">Privacy Policy</a></Li>
                        <li><a href="https://lakhiairconditioners.com">INFO</a></li>
                        <li><a href="https://made.lakhiairconditioners.com">VIDEOS MADE</a></li>
                    </ul>
                </div>
                <div class="foot-col-4">
                    <h3>Follow us</h3>
                    <ul>
                        <Li><a href="https://www.instagram.com/lakhi_electronic_airconditions/">Instagram</a></Li>
                        <Li><a href="https://www.facebook.com/lakhielectronicsairconditioner">Facebook</a></Li>
                    </ul>
                    <h3 style="margin-top: 20px">Contact Info</h3>
                    <ul>
                        <li><a href="tel:+919825513000">+919825513000</a></li>
                        <li><a href="mailto:info@lakhiairconditioners?subject=Feedback&amp;body=Hi%20there,%20I%20have%20some%20feedback%20for%20you.">info@lakhiairconditioners.com</a></li>
                        <li><a href="https://bc.lakhiairconditioners.com">Business-card</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <p class="copyright">copyright 2025 lakhiairconditioners<br>
               all right given to fontawesome for their icons
               <a href="https://www.flaticon.com/free-icons/menu" title="menu icons">Menu icons created by ariefstudio - Flaticon</a></p>

        </div>
    </div>

    <!-- IMPORTANT: Ensure data.js and products_data.js are loaded before this script -->
    <script src="data.js"></script>
    <script src="products_data.js"></script>
    
    <script>
        // Menu toggle function from the template
        var Menuitems = document.getElementById('Menuitems');
        // Ensure Menuitems exists before setting style
        if (Menuitems) {
            Menuitems.style.maxHeight = "0px"; // Initialize closed
        }

        function menutoggle(){
            if(Menuitems) { // Check again if Menuitems exists
                if(Menuitems.style.maxHeight == "0px") {
                    Menuitems.style.maxHeight = "200px";
                } else {
                    Menuitems.style.maxHeight = "0px";
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            let billTitle = "Bill Details";
            let customer = { name: 'N/A', addr1: 'N/A', ct: 'N/A', pincode: 'N/A' };
            let products = [];
            let calculatedSubtotal = 0;

            // Default values for tax and total, can be overridden by Data.js or URL params
            let displaySubtotal = '₹0.00';
            let displayTax = '*GET TOTAL BY CONTACTING US*';
            let displayTotal = '*GET TOTAL BY CONTACTING US*';
            
            const customerCodeParam = params.get('ccode'); // New parameter for customer code lookup
            const productsListParam = params.get('products'); // New parameter for product list
            const infoParam = params.get('info'); // General info/title override

            // --- 1. Determine Customer Details ---
            if (customerCodeParam) {
                // Attempt to load customer from data.js
                const customerData = window.billData ? window.billData[customerCodeParam] : null;
                if (customerData) {
                    customer.name = customerData.name || 'N/A';
                    customer.addr1 = customerData.addr1 || 'N/A';
                    customer.ct = customerData.ct || 'N/A';
                    customer.pincode = customerData.pincode || 'N/A';
                    // If a specific bill ID is also needed from data.js, it would be handled here
                    // For now, 'ccode' only pulls customer details, not a specific bill's products.
                    // If you need a specific bill's products from data.js, you'd need another parameter
                    // like 'billId' and logic to fetch products from customerData[billId].products
                } else {
                    console.warn(`Customer with code '${customerCodeParam}' not found in data.js. Checking URL parameters for customer info.`);
                    // Fallback to URL parameters if customer code not found
                    customer.name = params.get('customerName') || 'N/A';
                    customer.addr1 = params.get('customerAddr1') || 'N/A';
                    customer.ct = params.get('customerCt') || 'N/A';
                    customer.pincode = params.get('customerPincode') || 'N/A';
                }
            } else {
                // If no customer code, get customer details directly from URL parameters
                customer.name = params.get('customerName') || 'N/A';
                customer.addr1 = params.get('customerAddr1') || 'N/A';
                customer.ct = params.get('customerCt') || 'N/A';
                customer.pincode = params.get('customerPincode') || 'N/A';
            }

            // --- 2. Determine Products ---
            if (productsListParam) {
                const productDefinitions = productsListParam.split('||'); // Split by double pipe for each product
                let tempProducts = [];

                productDefinitions.forEach(productDefString => {
                    const productParams = new URLSearchParams(productDefString);
                    const type = productParams.get('type');

                    if (type === 'SR') {
                        // Product lookup from products_data.js
                        const serialNo = productParams.get('sr');
                        const quantity = parseInt(productParams.get('qty'), 10) || 1;

                        if (serialNo && window.allProductsData && Array.isArray(window.allProductsData)) {
                            const fullProduct = window.allProductsData.find(p => p.serial_no === serialNo);
                            if (fullProduct) {
                                tempProducts.push({
                                    PN: fullProduct.serial_no, // Using serial_no as PN for consistency with table
                                    SR: fullProduct.serial_no,
                                    name: fullProduct.name,
                                    price: fullProduct.price,
                                    qty: quantity
                                });
                            } else {
                                console.warn(`Product with Serial No: ${serialNo} not found in products_data.js.`);
                            }
                        } else {
                            console.warn(`Missing serial number or products_data.js not loaded for SR type product: ${productDefString}`);
                        }
                    } else if (type === 'DIRECT') {
                        // Product defined directly in URL
                        const name = productParams.get('name');
                        const price = parseFloat(productParams.get('price'));
                        const quantity = parseInt(productParams.get('qty'), 10) || 1;
                        const sr_opt = productParams.get('sr_opt'); // Optional serial number for direct products

                        if (name && !isNaN(price)) {
                            tempProducts.push({
                                PN: sr_opt || 'N/A', // Use optional SR as PN or N/A
                                SR: sr_opt || 'N/A',
                                name: name,
                                price: price,
                                qty: quantity
                            });
                        } else {
                            console.warn(`Invalid or incomplete DIRECT type product: ${productDefString}`);
                        }
                    } else {
                        console.warn(`Unknown product type or malformed product definition: ${productDefString}`);
                    }
                });
                products = tempProducts; // Assign parsed products
            } else {
                console.info("No 'products' parameter found in URL for dynamic product list.");
            }

            // --- 3. Handle Legacy 'Data' and 'Bill' parameters if 'products' is not used ---
            // This section is kept for backward compatibility with your previous URL structures.
            // If 'products' parameter is used, this block will be skipped.
            if (!productsListParam) {
                const dataParam = params.get('Data'); // Original parameter for data.js lookup
                const billParam = params.get('Bill'); // Original parameter for dynamic products

                if (dataParam) {
                    // Original Scenario 1: Data lookup from data.js (for customer AND products)
                    const dataParts = dataParam.split('?for?');
                    if (dataParts.length === 2) {
                        const customerCode = dataParts[0];
                        const quotationIdentifier = dataParts[1];

                        const customerData = window.billData ? window.billData[customerCode] : null;

                        if (customerData) {
                            // Overwrite customer details if found via dataParam
                            customer.name = customerData.name || 'N/A';
                            customer.addr1 = customerData.addr1 || 'N/A';
                            customer.ct = customerData.ct || 'N/A';
                            customer.pincode = customerData.pincode || 'N/A';

                            const quotationData = customerData[quotationIdentifier];
                            if (quotationData) {
                                if (quotationData.products && Array.isArray(quotationData.products)) {
                                    products = quotationData.products;
                                }

                                // Check for pre-set subtotal, tax, and total from Data.js
                                if (quotationData.billSubtotal !== undefined) {
                                    displaySubtotal = `₹${parseFloat(quotationData.billSubtotal).toLocaleString('en-IN')}`;
                                }
                                if (quotationData.billTax !== undefined) {
                                    displayTax = quotationData.billTax;
                                }
                                if (quotationData.billTotal !== undefined) {
                                    displayTotal = quotationData.billTotal;
                                }
                            }
                        }
                    }
                } else if (billParam) {
                    // Original Scenario 2: Dynamic Bill from 'Bill' parameter (for customer AND products)
                    // This logic is simplified as the new 'products' parameter handles this more robustly.
                    // If you still need the old 'PN=X&name=Y' parsing, it would go here.
                    // For now, if 'products' is not used, and 'billParam' is, it will just show default messages.
                    billTitle = infoParam || "Dynamic Bill (Legacy)";
                    document.getElementById('noProductsMessage').textContent = "Legacy 'Bill' parameter detected. Please use the new 'products' parameter for dynamic bills.";
                    document.getElementById('noProductsMessage').style.display = 'block';
                }
            }


            // --- 4. Finalize Bill Title ---
            if (infoParam) {
                billTitle = infoParam;
            } else if (customerCodeParam) {
                billTitle = `Bill for ${customer.name}`;
            } else if (products.length > 0) {
                billTitle = "Dynamic Bill";
            } else {
                billTitle = "No Bill Data Provided";
                document.getElementById('noProductsMessage').textContent = "Please provide 'ccode' or 'products' parameters in the URL, or use legacy 'Data' parameter.";
                document.getElementById('noProductsMessage').style.display = 'block';
            }


            // --- 5. Update HTML Elements ---
            document.getElementById('billTitle').textContent = billTitle;
            document.getElementById('customerName').textContent = customer.name;
            document.getElementById('customerAddr1').textContent = customer.addr1;
            document.getElementById('customerCt').textContent = customer.ct;
            document.getElementById('customerPincode').textContent = customer.pincode;

            const productTableBody = document.getElementById('productTableBody');
            productTableBody.innerHTML = ''; // Clear existing rows
            
            if (products.length > 0) {
                products.forEach(product => {
                    const row = document.createElement('tr');
                    const price = parseFloat(product.price) || 0;
                    const qty = parseInt(product.qty) || 1;
                    const itemTotal = price * qty;
                    calculatedSubtotal += itemTotal; // Sum up for dynamically calculated subtotal

                    row.innerHTML = `
                        <td>
                            <div class="cart-info">
                                <img src="https://placehold.co/80x80/cccccc/ffffff?text=Product" alt="${product.name || 'Product'}">
                                <div>
                                    <small>PN: ${product.PN || 'N/A'}</small>
                                    <p>${product.name || 'N/A'}</p>
                                    <small>Price: ₹${price.toFixed(2)}</small>
                                    <br><small>SR: ${product.SR || 'N/A'}</small>
                                </div>
                            </div>
                        </td>
                        <td>${qty} unit</td>
                        <td>₹${itemTotal.toFixed(2)}</td>
                        <td></td> <!-- Empty cell for Action column -->
                    `;
                    productTableBody.appendChild(row);
                });
                document.getElementById('noProductsMessage').style.display = 'none';
            } else {
                // If no products are found after all parsing attempts
                document.getElementById('noProductsMessage').style.display = 'block';
            }

            // Populate the total price section, prioritizing pre-set values from data.js if applicable
            // Otherwise, use dynamically calculated subtotal. Tax and Total remain as contact us.
            if (displaySubtotal === '₹0.00' && calculatedSubtotal > 0) {
                 document.getElementById('billSubtotal').textContent = `₹${calculatedSubtotal.toLocaleString('en-IN')}`;
            } else {
                 document.getElementById('billSubtotal').textContent = displaySubtotal;
            }
            document.getElementById('billTax').textContent = displayTax;
            document.getElementById('billGrandTotal').textContent = displayTotal;
        });
    </script>
</body>
</html>
