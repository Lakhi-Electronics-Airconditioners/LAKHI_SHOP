<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Veiw a bill (will not work without a bill info)">
    <title>Lakhi Airconditioners | Bill Details</title>
    <link rel="icon" href="img/1x1-logo.png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.css">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* General styling for containers */
        .small-container {
            max-width: 1080px;
            margin: auto;
            padding-left: 25px;
            padding-right: 25px;
        }

        .cart-page {
            margin: 80px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .title {
            text-align: center;
            margin: 0 auto 30px;
            position: relative;
            line-height: 60px;
            color: #f44336; /* Red for main titles */
        }

        /* Customer Info Section */
        .customer-info {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .customer-info h3 {
            margin-bottom: 15px;
            color: #f44336; /* Red for sub-titles */
        }
        .customer-info p {
            margin-bottom: 8px;
            color: #555;
        }
        .customer-info span {
            font-weight: 600;
            color: #333;
        }

        /* Product Table */
        #productTable {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        #productTable th, #productTable td {
            border: 1px solid #ddd;
            padding: 12px 15px;
            text-align: left;
            vertical-align: middle;
        }
        #productTable th {
            background-color: #f44336; /* Red for table headers */
            color: white;
            font-weight: 600;
        }
        #productTable tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        #productTable tbody tr:hover {
            background-color: #e9e9e9;
        }
        .cart-info {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }
        .cart-info img {
            width: 80px;
            height: 80px;
            margin-right: 10px;
            border-radius: 5px;
            object-fit: cover;
        }
        .cart-info div {
            flex: 1;
        }
        .cart-info p {
            font-weight: bold;
            color: #333;
            margin: 0;
        }
        .cart-info small {
            color: #777;
            display: block;
            font-size: 0.8em;
        }

        /* Total Price Section */
        .total-price {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            flex-direction: column;
            align-items: flex-end;
        }
        .total-price table {
            border-top: 3px solid #f44336; /* Red border top */
            width: 100%;
            max-width: 380px;
            border-collapse: collapse;
        }
        .total-price td:first-child {
            text-align: left;
            padding: 10px 15px;
            color: #555;
        }
        .total-price td:last-child {
            text-align: right;
            padding: 10px 15px;
            font-weight: bold;
            color: #333;
        }
        .total-price tr:last-child td {
            font-size: 1.2em;
            color: #f44336; /* Red for grand total */
        }

        /* Loading/Error Messages */
        #loadingMessage, #errorMessage {
            text-align: center;
            margin-top: 50px;
            font-size: 1.2em;
            color: #777;
        }
        #errorMessage {
            color: red;
        }
        #noProductsMessage {
            text-align: center;
            color: #777;
            margin-top: 20px;
            display: none; /* Hidden by default */
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .cart-page {
                margin: 20px auto;
                padding: 15px;
            }
            .title {
                font-size: 1.8rem !important;
            }
            #productTable th, #productTable td {
                padding: 8px 10px;
                font-size: 0.9em;
            }
            .cart-info img {
                width: 60px;
                height: 60px;
            }
            .total-price table {
                max-width: 100%;
            }
        }
        
        /* New button and note styles */
        .btn {
            background-color: #f44336;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #d32f2f;
        }

        #billNoteContainer h4 {
            color: #333;
            border-bottom: 2px solid #ccc;
            padding-bottom: 5px;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        #billNoteContainer p {
            font-style: italic;
            color: #555;
            line-height: 1.6;
        }
    </style>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('✅ Service Worker registered'))
                .catch(err => console.error('❌ Service Worker error:', err));
        }
    </script>
</head>
<body>
    <div id="tacpp" class="w3-modal-content">
        <div class="w3-center" style="margin-bottom:20px;">
            <span
                onclick="closeModal()"
                class="close-button"
                title="Close Modal">
                Close ×
            </span>
            <h2>Please Agree to Proceed</h2>
        </div>
        <form class="w3-container">
            <div class="w3-section" style="margin-bottom:20px; text-align:left;">
                <input type="checkbox" id="agree">
                <label for="agree">
                    I agree to the
                    <a href="../info/TAC">
                        Terms and Conditions
                    </a>
                    and
                    <a href="../info/PP">
                        Privacy Policy
                    </a>.
                </label>
            </div>
            <p style="font-size:14px; margin-bottom:20px;">
                * Prices may not be accurate, and not all products are listed.<br>
                *product may not be in stock or may not even be buyable anymore<br>
                * price may go down because of some gst/cst payment things
            </p>
            <div class="w3-center">
                <button
                    class="btn-modal"
                    onclick="continueAction(event)">
                    Continue
                </button>
            </div>
        </form>
    </div>

    <div id="updateTacppModal" class="w3-modal-content">
        <div class="w3-center" style="margin-bottom:20px;">
            <span
                onclick="closeUpdateModal()"
                class="close-button"
                title="Close Modal">
                Close ×
            </span>
            <h2>Terms and Conditions Updated</h2>
        </div>
        <form class="w3-container">
            <div class="w3-section" style="margin-bottom:20px; text-align:left;">
                <p>Our Terms and Conditions and Privacy Policy have been updated. Please review the changes and agree to continue.</p>
                <input type="checkbox" id="agreeUpdate">
                <label for="agreeUpdate">
                    I agree to the updated
                    <a href="../info/TAC">
                        Terms and Conditions
                    </a>
                    and
                    <a href="../info/PP">
                        Privacy Policy
                    </a>.
                </label>
            </div>
            <div class="w3-center">
                <button
                    class="btn-modal"
                    onclick="continueUpdateAction(event)">
                    Agree to Update
                </button>
            </div>
        </form>
    </div>
    <script src="TACPP.js" defer></script>
    <div class="header-NAV">
        <div class="container">
            <div class="navbar">
                <div class="logo"><img src="img/NABR/log.jpg" width="125px" alt="Company Logo"></div>
                <nav>
                    <ul id="Menuitems">
                        <li><a href="https://shop.lakhiairconditioners.com/">Home</a></li>
                        <li><a href="about">About Us</a></li>
                        <li><a href="products">All Products</a></li>
                        <li><a href="AC-only">AC Products</a></li>
                        <li><a href="contact">Contact Us</a></li>
                        <li><a href="account">Account</a></li>
                    </ul>
                </nav>
                <a href="cart"><img src="img/NABR/SCI.png" width="30px" alt="Shopping Cart Icon"></a></li>
                <img src="img/NABR/menu.png" class="menu-icon" onclick="menutoggle()" alt="Menu Icon">
            </div>
        </div>
    </div>
    <div class="color-NAV"><br><br></div>
    <div><a href="#" class="back-button" onclick="history.back(); return false;">&larr; Back</a></div>

    <div class="small-container cart-page">
        <div id="loadingMessage" class="loading-message">Loading bill details...</div>
        <div id="errorMessage" class="error-message hidden"></div>

        <h1 id="billTitle" class="title" style="font-size: xx-large;"></h1>
        <br>

        <div class="customer-info">
            <h3 style="margin-bottom: 15px; color: #f44336;">bills Details</h3>
            <p><span>Customer Code:</span> <span id="customerCodeDisplay">N/A</span></p>
            <p><span>Bill Number:</span> <span id="billIdDisplay">N/A</span></p>
            <p><span>Bill Code:</span> <span id="billCodeDisplay">N/A</span></p>
            <h3 style="margin-bottom: 15px; color: #f44336;">Note</h3>
            <p id="billNoteText" style="white-space: pre-wrap;color:#000000"><span></span></p>
            <h3 style="margin-bottom: 15px; color: #f44336;">Customer Details</h3>
            <p><span>Name:</span> <span id="customerName">N/A</span></p>
            <p><span>Address:</span> <span id="customerAddr">N/A</span></p>
            <p><span>City:</span> <span id="customerCity">N/A</span></p>
            <p><span>Pincode:</span> <span id="customerPincode">N/A</span></p>
        </div>

        <div class="row" id="billNoteContainer" style="display:none; margin-top: 20px;">
            <div class="col-12" style="text-align: left;color:#f44336">
                <br>
            </div>
        </div>

        <table id="productTable">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Unit</th>
                    <th>Subtotal</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                </tbody>
        </table>
        <p id="noProductsMessage" style="text-align: center; color: #777; margin-top: 20px; display: none;">No products found for this bill.</p>

        <div class="total-price">
            <table>
                <tr>
                    <td>Subtotal</td>
                    <td id="billSubtotal">₹0.00</td>
                </tr>
                <tr>
                    <td>Tax</td>
                    <td id="billTax">*(not defined)*</td>
                </tr>
                <tr>
                    <td>Total</td>
                    <td id="billGrandTotal">*(not defined)*</td>
                </tr>
            </table>
             <div style="width: 100%; text-align: right; margin-top: 15px;">
                <button id="downloadBillButton" class="btn hidden">Download Bill</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="foot-col-1">
                    <h3>Download Our App</h3>
                    <p>Download App for Android but not <u>iphone</u>for now</p>
                    <div class="app-logo">
                        <a href="https://drive.google.com/uc?export=download&id=1jx18KtEjAwaQtto0XqbPWe8cz49oUuUG"><img src="img/NABR/apk-down.jpeg" alt="Download App"></a>
                    </div>
                </div>
                <div class="foot-col-2">
                    <img src="img/log-w.png" width="200px" alt="Lakhi Airconditioners Logo">
                    <p>Our Purpose Is to give the best deal and products to the Many.</p>
                </div>
                <div class="foot-col-3">
                    <h3>Useful links</h3>
                    <ul>
                        <Li><a href="https://main.lakhiairconditioners.com/TAC">Terms and Conditions</a></Li>
                        <Li><a href="https://main.lakhiairconditioners.com/PP">Privacy Policy</a></Li>
                        <li><a href="https://lakhiairconditioners.com">INFO</a></li>
                        <li><a href="https://maps.lakhiairconditioners.com">G-MAPS</a></li>
                    </ul>
                </div>
                <div class="foot-col-4">
                    <h3>Follow us</h3>
                    <ul>
                        <Li><a href="https://insta.lakhiairconditioners.com/">Instagram</a></Li>
                        <Li><a href="https://fb.lakhiairconditioners.com/">Facebook</a></Li>
                    </ul>
                    <h3 style="margin-top: 20px">Contact Info</h3>
                    <ul>
                        <li><a href="tel:+919825513000">+919825513000</a></li>
                        <li><a href="mailto:info@lakhiairconditioners?subject=Feedback&amp;body=Hi%20there,%20I%20have%20some%20feedback%20for%20you.">info@lakhiairconditioners.com</a></li>
                        <li><a href="https://bc.lakhiairconditioners.com">Business-card</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <p class="copyright">&copy; 2025 Lakhi Airconditioners. All rights reserved.<br>
                all right given to fontawesome for their icons
                <a href="https://www.flaticon.com/free-icons/menu" title="menu icons">Menu icons created by ariefstudio - Flaticon</a></p>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC-16u2n4IaGRmg88nsPmMYCGKp2jjL9Bg",
            authDomain: "lakhi-airconditioners.firebaseapp.com",
            projectId: "lakhi-airconditioners",
            storageBucket: "lakhi-airconditioners.firebasestorage.app",
            messagingSenderId: "284430318185",
            appId: "1:284430318185:web:ad09598be7a16ab46a00f8",
            measurementId: "G-LB63B1FRYC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appIdFromConfig = firebaseConfig.projectId;

        // --- Helper Functions ---
        function showMessage(element, message, type = 'error') {
            if (element) {
                element.textContent = message;
                element.classList.remove('success', 'error');
                element.classList.add(type);
                element.classList.remove('hidden');
            }
        }

        function hideLoading() {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) loadingMessage.classList.add('hidden');
        }

        function hideMessages() {
            const loadingMessage = document.getElementById('loadingMessage');
            const errorMessage = document.getElementById('errorMessage');
            const noProductsMessage = document.getElementById('noProductsMessage');
            const downloadButton = document.getElementById('downloadBillButton');

            if (loadingMessage) loadingMessage.classList.add('hidden');
            if (errorMessage) errorMessage.classList.add('hidden');
            if (noProductsMessage) noProductsMessage.classList.add('hidden');
            if (downloadButton) downloadButton.classList.add('hidden');
        }

        function handleImageError(imgElement, serialNo) {
            if (!imgElement.dataset.serialFallbackAttempted) {
                imgElement.dataset.serialFallbackAttempted = 'true';
                imgElement.src = `img/PROC/${serialNo}.jpg`;
            } else {
                imgElement.onerror = null;
                imgElement.src = 'img/PROC/DP.png';
            }
        }
        window.handleImageError = handleImageError;

        function generatePDF() {
            const element = document.querySelector('.cart-page');
            const customerCode = document.getElementById('customerCodeDisplay')?.textContent || 'customerscode';
            const billId = document.getElementById('billIdDisplay')?.textContent || 'billid';
            const filename = `Lakhi_Airconditioners_Bill_${customerCode}-${billId}.pdf`;

            const options = {
                margin: [0.5, 0.5, 0.5, 0.5],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(options).from(element).save();
        }

        async function loadBillDetails(user) {
            hideMessages();
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) loadingMessage.classList.remove('hidden');

            const params = new URLSearchParams(window.location.search);
            const customerCode = params.get('customerCode');
            const billId = params.get('billId');
            const billCode = customerCode && billId ? `${customerCode}-${billId}` : 'N/A';

            const dynamicProductsParam = params.get('products');
            const dynamicSubtotal = params.get('subtotal');
            const dynamicTax = params.get('tax');
            const dynamicTotal = params.get('total');
            const dynamicType = params.get('type');
            const dynamicInfo = params.get('info');

            let billData = null;
            let customerData = null;
            let productsToDisplay = [];
            let finalBillTitle = 'Bill Details';
            let finalSubtotal = 0;
            let finalTax = '*(not defined)*';
            let finalTotal = '*(not defined)*';
            let downloadUrl = null;
            let noteText = null;

            try {
                const customerNameElem = document.getElementById('customerName');
                const customerAddrElem = document.getElementById('customerAddr');
                const customerCityElem = document.getElementById('customerCity');
                const customerPincodeElem = document.getElementById('customerPincode');
                const customerCodeElem = document.getElementById('customerCodeDisplay');
                const billIdElem = document.getElementById('billIdDisplay');
                const billCodeElem = document.getElementById('billCodeDisplay');
                const errorMessage = document.getElementById('errorMessage');

                if (customerCode) {
                    const customerDocRef = doc(db, 'artifacts', appIdFromConfig, 'customers', customerCode);
                    const customerDocSnap = await getDoc(customerDocRef);
                    if (customerDocSnap.exists()) {
                        customerData = customerDocSnap.data();
                    } else {
                        console.warn(`Customer with code ${customerCode} not found in Firestore.`);
                    }
                }

                if (!customerData && params.get('customerName')) {
                    customerData = {
                        NAME: params.get('customerName') || 'N/A',
                        addr: params.get('customerAddr1') ? [params.get('customerAddr1')] : [],
                        ct: params.get('customerCt') || 'N/A',
                        pincode: params.get('customerPincode') || 'N/A'
                    };
                } else if (!customerCode && !params.get('customerName')) {
                    showMessage(errorMessage, 'No customer details provided in URL or Firebase.', 'error');
                    const billTitleElem = document.getElementById('billTitle');
                    if (billTitleElem) billTitleElem.textContent = 'Error Loading Bill';
                    hideLoading();
                    return;
                }

                if (customerCode && billId && !dynamicProductsParam) {
                    const billDocRef = doc(db, 'artifacts', appIdFromConfig, 'customers', customerCode, 'bills', billId);
                    const billDocSnap = await getDoc(billDocRef);
                    if (billDocSnap.exists()) {
                        billData = billDocSnap.data();
                        productsToDisplay = billData.products || [];
                        finalSubtotal = billData.billSubtotal || 0;
                        finalTax = billData.billTax || '*(not defined)*';
                        finalTotal = billData.billTotal || '*(not defined)*';
                        downloadUrl = billData.url || null;
                        noteText = billData.note || null;

                        if (billData.title === "C" && billData.Cname) {
                            finalBillTitle = billData.Cname;
                        } else if (billData.type === 1) {
                            finalBillTitle = "Invoice #" + billId;
                        } else if (billData.type === 2) {
                            finalBillTitle = "Quotation #" + billId;
                        } else {
                            finalBillTitle = "Bill Details #" + billId;
                        }
                    } else {
                        showMessage(errorMessage, `Bill "${billId}" for customer "${customerCode}" not found.`, 'error');
                        const billTitleElem = document.getElementById('billTitle');
                        if (billTitleElem) billTitleElem.textContent = 'Bill Not Found';
                        hideLoading();
                        return;
                    }
                }

                if (dynamicProductsParam) {
                    try {
                        productsToDisplay = dynamicProductsParam.split('||').map(productStr => {
                            const parts = new URLSearchParams(productStr);
                            const type = parts.get('type');
                            if (type === 'SR') {
                                return {
                                    SR: parts.get('sr'),
                                    qty: parseInt(parts.get('qty'), 10),
                                    price: parseFloat(parts.get('price')) || undefined
                                };
                            } else if (type === 'DIRECT') {
                                return {
                                    name: parts.get('name'),
                                    price: parseFloat(parts.get('price')),
                                    qty: parseInt(parts.get('qty'), 10),
                                    SR: parts.get('sr_opt') || 'N/A'
                                };
                            }
                            return null;
                        }).filter(p => p !== null);

                        finalSubtotal = productsToDisplay.reduce((sum, p) => {
                            const price = parseFloat(p.price) || 0;
                            const qty = parseInt(p.qty, 10) || 0;
                            return sum + (price * qty);
                        }, 0);

                    } catch (e) {
                        console.error("Error parsing dynamic products from URL:", e);
                        showMessage(errorMessage, "Error loading dynamic product data from URL.", 'error');
                        productsToDisplay = [];
                    }
                }

                if (dynamicSubtotal) finalSubtotal = parseFloat(dynamicSubtotal);
                if (dynamicTax) finalTax = dynamicTax;
                if (dynamicTotal) finalTotal = dynamicTotal;
                if (dynamicInfo) {
                    finalBillTitle = dynamicInfo;
                } else if (dynamicType) {
                    const typeNum = parseInt(dynamicType, 10);
                    if (typeNum === 1) finalBillTitle = 'Invoice';
                    else if (typeNum === 2) finalBillTitle = 'Quotation';
                    else finalBillTitle = `Type ${dynamicType}`;
                }

                // --- Handle Download Button Logic Here ---
                const downloadButton = document.getElementById('downloadBillButton');
                if (downloadButton) {
                    downloadButton.classList.remove('hidden');
                    if (downloadUrl) {
                        downloadButton.onclick = () => {
                            window.open(downloadUrl, '_blank');
                        };
                    } else {
                        downloadButton.onclick = generatePDF;
                    }
                }
                // --- End Download Button Logic ---

                // --- NEW CODE FOR THE NOTE ---
                const billNoteContainer = document.getElementById('billNoteContainer');
                const billNoteText = document.getElementById('billNoteText');
                if (billNoteContainer && billNoteText) {
                    if (noteText && noteText.trim() !== '') {
                        billNoteText.textContent = noteText;
                        billNoteContainer.style.display = 'block';
                    } else {
                        billNoteContainer.style.display = 'none';
                    }
                }
                // --- END NEW CODE ---

                const billTitleElem = document.getElementById('billTitle');
                if (billTitleElem) billTitleElem.textContent = finalBillTitle;

                if (customerData) {
                    if (customerNameElem) customerNameElem.textContent = customerData.NAME || 'N/A';
                    if (customerAddrElem) {
                        if (Array.isArray(customerData.addr) && customerData.addr.length > 0) {
                            customerAddrElem.textContent = customerData.addr
                                .map(part => typeof part === 'string' ? part.trim() : JSON.stringify(part))
                                .filter(part => part !== '')
                                .join(', ') || 'N/A';
                        } else {
                            customerAddrElem.textContent = 'N/A';
                        }
                    }
                    if (customerCityElem) customerCityElem.textContent = customerData.ct || 'N/A';
                    if (customerPincodeElem) customerPincodeElem.textContent = customerData.pincode || 'N/A';
                } else {
                    if (customerNameElem) customerNameElem.textContent = 'N/A';
                    if (customerAddrElem) customerAddrElem.textContent = 'N/A';
                    if (customerCityElem) customerCityElem.textContent = 'N/A';
                    if (customerPincodeElem) customerPincodeElem.textContent = 'N/A';
                }

                if (customerCodeElem) customerCodeElem.textContent = customerCode || 'N/A';
                if (billIdElem) billIdElem.textContent = billId || 'N/A';
                if (billCodeElem) billCodeElem.textContent = billCode;

                const productTableBody = document.getElementById('productTableBody');
                const noProductsMessage = document.getElementById('noProductsMessage');

                if (productTableBody) productTableBody.innerHTML = '';
                if (productsToDisplay.length > 0) {
                    for (const product of productsToDisplay) {
                        let finalProductName = product.name || 'N/A Product';
                        let finalProductPrice = parseFloat(product.price);
                        let finalProductSR = product.SR || 'N/A';

                        if (isNaN(finalProductPrice) && finalProductSR !== 'N/A') {
                            try {
                                const productsCollectionRef = collection(db, "artifacts", appIdFromConfig, "products");
                                const q = query(productsCollectionRef, where("serial_no", "==", finalProductSR));
                                const querySnapshot = await getDocs(q);

                                if (!querySnapshot.empty) {
                                    const fetchedProduct = querySnapshot.docs[0].data();
                                    finalProductName = fetchedProduct.name || finalProductName;
                                    if (fetchedProduct.price && !isNaN(parseFloat(fetchedProduct.price))) {
                                        finalProductPrice = parseFloat(fetchedProduct.price);
                                    }
                                } else {
                                    console.warn(`Product with serial_no "${finalProductSR}" not found in products collection. Displaying data from bill.`);
                                }
                            } catch (prodError) {
                                console.error(`Error querying product by serial_no "${finalProductSR}":`, prodError);
                            }
                        }

                        finalProductPrice = isNaN(finalProductPrice) ? 0 : finalProductPrice;

                        const qty = parseInt(product.quantity || product.qty, 10) || 1;
                        const itemTotal = finalProductPrice * qty;
                        const imagePath = `img/PROC/${finalProductSR}.jpg`;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <div class="cart-info">
                                    <img src="${imagePath}" alt="${finalProductName}" onerror="handleImageError(this, '${finalProductSR}');" style="display: flex;justify-content: center;align-items: center;width: 80px;height: 80px;margin-right: 10px;border-radius: 5px;object-fit: cover;">
                                    <div>
                                        <small>PN/SR: ${finalProductSR}</small>
                                        <p>${finalProductName}</p>
                                        <small>Price: ₹${finalProductPrice.toFixed(2)}</small>
                                    </div>
                                </div>
                            </td>
                            <td>${qty} unit</td>
                            <td>₹${itemTotal.toFixed(2)}</td>
                            <td></td>
                        `;
                        productTableBody.appendChild(row);
                    }
                    if (noProductsMessage) noProductsMessage.style.display = 'none';
                } else {
                    if (noProductsMessage) noProductsMessage.style.display = 'block';
                }

                const billSubtotalElem = document.getElementById('billSubtotal');
                const billTaxElem = document.getElementById('billTax');
                const billGrandTotalElem = document.getElementById('billGrandTotal');

                if (billSubtotalElem) billSubtotalElem.textContent = `₹${parseFloat(finalSubtotal).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                if (billTaxElem) billTaxElem.textContent = finalTax;
                if (billGrandTotalElem) billGrandTotalElem.textContent = finalTotal;

            } catch (error) {
                console.error("Error loading bill details:", error);
                showMessage(errorMessage, `Failed to load bill: ${error.message}. Check console for details.`, 'error');
                const billTitleElem = document.getElementById('billTitle');
                if (billTitleElem) billTitleElem.textContent = 'Error Loading Bill';
            } finally {
                hideLoading();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, (user) => {
                loadBillDetails(user);
            });
        });

        var Menuitems = document.getElementById("Menuitems");
        if (Menuitems) {
            Menuitems.style.maxHeight = "0px";
            window.menutoggle = function() {
                if (Menuitems.style.maxHeight == "0px") {
                    Menuitems.style.maxHeight = "200px";
                } else {
                    Menuitems.style.maxHeight = "0px";
                }
            };
        } else {
            console.warn("Menuitems element not found for mobile toggle.");
        }
    </script>
</body>
</html>