<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakhi Airconditioners | Sign Up</title>
    <!-- Relative paths for linked files are correct -->
    <link rel="icon" href="../img/1x1-logo.png">
    <link rel="stylesheet" href="../styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.css">
    <link rel="stylesheet" href="../DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.min.css">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>
    <div class="header-NAV">
        <div class="container">
            <div class="navbar">
                <!-- Relative paths for linked files are correct -->
                <div class="logo"><img src="../img/NABR/log.jpg" width="125px" alt="Company Logo"></div>
                <nav>
                    <ul id="Menuitems">
                        <li><a href="https://shop.lakhiairconditioners.com">Home</a></li>
                        <li><a href="../about">About Us</a></li>
                        <li><a href="../products">All Products</a></li>
                        <li><a href="../AC-only">AC Products</a></li>
                        <li><a href="../contact">Contact Us</a></li>
                        <li><a href="../account">Account</a></li>
                    </ul>
                </nav>
                <a href="../cart"><img src="../img/NABR/SCI.png" width="30px" alt="Shopping Cart Icon"></a>
                <img src="../img/NABR/menu.png" class="menu-icon" onclick="menutoggle()" alt="Menu Icon">
            </div>
        </div>
    </div>
    <div class="color-NAV">
        <a href="../ls.html" class="back-button">&larr; Back to Account Access</a>
    </div>

    <div class="account-container">
        <h1 class="title">Create Your Account</h1>
        <div class="form-box">
            <form id="signUpForm">
                <div class="form-group">
                    <label for="signUpEmail">Email:</label>
                    <input type="email" id="signUpEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="signUpPassword">Password:</label>
                    <input type="password" id="signUpPassword" placeholder="Enter your password" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password:</label>
                    <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
                </div>
                <div id="recaptcha-container-signup" style="margin-top: 15px;"></div>
                <button type="submit" class="btn" id="signupBtn">Sign Up</button> <p class="error-message" id="signUpError"></p>
                <p class="success-message" id="signUpSuccess"></p>
            </form>

            <div class="social-login-options">
                <p>Or sign up with:</p>
                <button id="googleSignUpBtn" class="btn social-btn google-btn">
                    <i class="fab fa-google"></i> Sign Up with Google
                </button>
                <button id="appleSignUpBtn" class="btn social-btn apple-btn">
                    <i class="fab fa-apple"></i> Sign Up with Apple
                </button>
                <button id="githubSignUpBtn" class="btn social-btn github-btn">
                    <i class="fab fa-github"></i> Sign Up with GitHub
                </button>
                <button id="facebookSignUpBtn" class="btn social-btn facebook-btn">
                    <i class="fab fa-facebook-f"></i> Sign Up with Facebook
                </button>
            </div>

            <p class="toggle-form-text">Already have an account? <a href="signin.html">Sign In here</a></p>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="foot-col-1">
                    <h3>Download Our App</h3>
                    <p>Download App for Android but not <u>iphone</u>for now</p>
                    <div class="app-logo">
                        <!-- Corrected image path: changed from 'img/NABR/...' to '../img/NABR/...' -->
                        <a href="https://drive.google.com/uc?export=download&id=1jx18KtEjAwaQtto0XqbPWe8cz49oUuUG"><img src="../img/NABR/apk-down.jpeg" alt="Download App"></a>
                    </div>
                </div>
                <div class="foot-col-2">
                    <!-- Corrected image path: changed from 'img/log-w.png' to '../img/log-w.png' -->
                    <img src="../img/log-w.png" width="200px" alt="Lakhi Airconditioners Logo">
                    <p>Our Purpose Is to give the best deal and products to the Many.</p>
                </div>
                <div class="foot-col-3">
                    <h3>Useful links</h3>
                    <ul>
                        <Li><a href="https://main.lakhiairconditioners.com/TAC">Terms and Conditions</a></Li>
                        <Li><a href="https://main.lakhiairconditioners.com/PP">Privacy Policy</a></Li>
                        <li><a href="https://lakhiairconditioners.com">INFO</a></li>
                        <li><a href="https://maps.lakhiairconditioners.com">G-MAPS</a></li>
                    </ul>
                </div>
                <div class="foot-col-4">
                    <h3>Follow us</h3>
                    <ul>
                        <Li><a href="https://insta.lakhiairconditioners.com/">Instagram</a></Li>
                        <Li><a href="https://fb.lakhiairconditioners.com/">Facebook</a></Li>
                    </ul>
                    <h3 style="margin-top: 20px">Contact Info</h3>
                    <ul>
                        <li><a href="tel:+919825513000">+919825513000</a></li>
                        <li><a href="mailto:info@lakhiairconditioners?subject=Feedback&amp;body=Hi%20there,%20I%20have%20some%20feedback%20for%20you.">info@lakhiairconditioners.com</a></li>
                        <li><a href="https://bc.lakhiairconditioners.com">Business-card</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <p class="copyright">&copy; 2025 Lakhi Airconditioners. All rights reserved.<br>
                all right given to fontawesome for their icons
                <a href="https://www.flaticon.com/free-icons/menu" title="menu icons">Menu icons created by ariefstudio - Flaticon</a></p>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword, // Make sure you import this for email/password signup
            signInWithEmailAndPassword, // This is for sign-in, but good to have if you plan to reuse code
            GoogleAuthProvider,
            // Add these new providers:
            OAuthProvider, // For Apple
            GithubAuthProvider, // For GitHub
            FacebookAuthProvider, // For Facebook
            signInWithPopup,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { RecaptchaVerifier } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyC-16u2n4IaGRmg88nsPmMYCGKp2jjL9Bg",
            authDomain: "lakhi-airconditioners.firebaseapp.com",
            projectId: "lakhi-airconditioners",
            storageBucket: "lakhi-airconditioners.firebasestorage.app",
            messagingSenderId: "284430318185",
            appId: "1:284430318185:web:ad09598be7a16ab46a00f8",
            measurementId: "G-LB63B1FRYC"
          };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // UI Element References - Declared at the top for accessibility
        const signUpForm = document.getElementById('signUpForm');
        const signUpEmailInput = document.getElementById('signUpEmail');
        const signUpPasswordInput = document.getElementById('signUpPassword');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        const signUpError = document.getElementById('signUpError');
        const signUpSuccess = document.getElementById('signUpSuccess');
        const googleSignUpBtn = document.getElementById('googleSignUpBtn');
        const appleSignUpBtn = document.getElementById('appleSignUpBtn');
        const githubSignUpBtn = document.getElementById('githubSignUpBtn');
        const facebookSignUpBtn = document.getElementById('facebookSignUpBtn');
        const signupBtn = document.getElementById('signupBtn'); // Reference to the submit button

        // ReCAPTCHA initialization
        let recaptchaVerifier;
        const recaptchaContainer = document.getElementById('recaptcha-container-signup'); // Use specific ID for signup

        // Initialize reCAPTCHA on page load
        document.addEventListener('DOMContentLoaded', () => {
            if (recaptchaContainer) {
                // Pass the DOM element directly to RecaptchaVerifier
                recaptchaVerifier = new RecaptchaVerifier(auth, recaptchaContainer, {
                    'size': 'normal', // or 'invisible'
                    'callback': (response) => {
                        console.log("reCAPTCHA solved!");
                        if (signupBtn) signupBtn.disabled = false; // Enable button if reCAPTCHA solved
                    },
                    'expired-callback': () => {
                        console.log("reCAPTCHA expired!");
                        if (signupBtn) signupBtn.disabled = true; // Disable button if reCAPTCHA expires
                        // Rerender the recaptcha
                        recaptchaVerifier.render().then(function(widgetId) {
                            grecaptcha.reset(widgetId);
                        });
                    }
                });
                recaptchaVerifier.render().then(function(widgetId) {
                    console.log("reCAPTCHA rendered with widget ID:", widgetId);
                    // You might want to disable signupBtn until reCAPTCHA is solved:
                    // if (signupBtn) signupBtn.disabled = true;
                });
            }
        });

        // Function to display messages
        function showMessage(element, message, type = 'error') {
            if (element) { // Safety check
                element.textContent = message;
                element.className = type === 'success' ? 'success-message' : 'error-message';
                setTimeout(() => {
                    element.textContent = '';
                    element.className = '';
                }, 5000);
            }
        }

        // Email/Password Sign Up Form Submission
        if (signUpForm) {
            signUpForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (signUpError) signUpError.textContent = ''; // Clear previous errors, safety check

                const email = signUpEmailInput.value;
                const password = signUpPasswordInput.value;
                const confirmPassword = confirmPasswordInput.value;

                if (password !== confirmPassword) {
                    showMessage(signUpError, 'Passwords do not match.');
                    return;
                }

                // ReCAPTCHA verification before proceeding with Firebase signup
                if (recaptchaVerifier && recaptchaVerifier.size !== 'invisible' && !grecaptcha.getResponse(recaptchaVerifier.widgetId)) {
                    showMessage(signUpError, 'Please complete the reCAPTCHA.');
                    return;
                }

                try {
                    // If using invisible reCAPTCHA, execute it programmatically before createUserWithEmailAndPassword
                    if (recaptchaVerifier && recaptchaVerifier.size === 'invisible') {
                         await recaptchaVerifier.execute();
                         if (!grecaptcha.getResponse(recaptchaVerifier.widgetId)) {
                            showMessage(signUpError, 'reCAPTCHA verification failed. Please try again.');
                            return;
                        }
                    }

                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const currentUserId = user.uid;

                    // Create a basic user profile in Firestore
                    const appId = firebaseConfig.projectId; // Using projectId as appId for Firestore path
                    const userProfileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/user_profiles`, "profile");

                    await setDoc(userProfileDocRef, {
                        email: user.email,
                        createdAt: new Date().toISOString()
                        // customerCode, name, phone, address will be added on ls/su2.html
                    });

                    showMessage(signUpSuccess, 'Account created successfully! Redirecting to profile setup...', 'success');
                    // Give a small delay before redirecting to allow the user to see the success message
                    setTimeout(() => {
                        window.location.href = 'ls/su2.html'; // Redirect to profile completion page
                    }, 2000);
                } catch (error) {
                    console.error("Sign Up Error:", error);
                    let errorMessage = 'Sign up failed.';
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = 'This email is already in use.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = 'Invalid email address.';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Password is too weak (min 6 characters).';
                    } else if (error.code === 'auth/user-disabled') {
                        errorMessage = 'This user account has been disabled.';
                    }
                    showMessage(signUpError, errorMessage);
                } finally {
                    // Reset reCAPTCHA after submission (success or failure)
                    if (recaptchaVerifier && recaptchaVerifier.widgetId) {
                        grecaptcha.reset(recaptchaVerifier.widgetId);
                    }
                }
            });
        }


        // Google Sign Up
        if (googleSignUpBtn) {
            googleSignUpBtn.addEventListener('click', async () => {
                const provider = new GoogleAuthProvider();
                if (signUpError) signUpError.textContent = ''; // Clear previous errors

                try {
                    const userCredential = await signInWithPopup(auth, provider);
                    const user = userCredential.user;
                    const currentUserId = user.uid;

                    // Check if profile already exists before creating a new one
                    const appId = firebaseConfig.projectId;
                    const userProfileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/user_profiles`, "profile");
                    const docSnap = await getDoc(userProfileDocRef);

                    if (!docSnap.exists()) {
                        await setDoc(userProfileDocRef, {
                            email: user.email,
                            createdAt: new Date().toISOString()
                        });
                    }

                    showMessage(signUpSuccess, 'Signed up with Google successfully! Redirecting to profile setup...', 'success');
                    setTimeout(() => {
                        window.location.href = 'ls/su2.html'; // Redirect to profile completion page
                    }, 2000);
                } catch (error) {
                    console.error("Google Sign Up Error:", error);
                    let errorMessage = 'Google sign-up failed.';
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Google sign-up popup closed.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = 'Google sign-up already in progress.';
                    } else if (error.code === 'auth/account-exists-with-different-credential') {
                        errorMessage = 'An account with this email already exists using different credentials.';
                    }
                    showMessage(signUpError, errorMessage);
                }
            });
        }


        // Apple Sign Up
        if (appleSignUpBtn) { // Safety check
            appleSignUpBtn.addEventListener('click', async () => {
                const provider = new OAuthProvider('apple.com');
                if (signUpError) signUpError.textContent = '';
                try {
                    const userCredential = await signInWithPopup(auth, provider);
                    const user = userCredential.user;
                    const currentUserId = user.uid;

                    // Firestore profile creation for social sign-up
                    const appId = firebaseConfig.projectId;
                    const userProfileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/user_profiles`, "profile");
                    const docSnap = await getDoc(userProfileDocRef);

                    if (!docSnap.exists()) {
                        await setDoc(userProfileDocRef, {
                            email: user.email,
                            createdAt: new Date().toISOString()
                        });
                    }

                    showMessage(signUpSuccess, 'Signed up with Apple successfully! Redirecting to profile setup...', 'success');
                    setTimeout(() => {
                        window.location.href = 'ls/su2.html';
                    }, 2000);
                } catch (error) {
                    console.error("Apple Sign Up Error:", error);
                    let errorMessage = 'Apple sign-up failed.';
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Apple sign-up popup closed.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = 'Apple sign-up already in progress.';
                    } else if (error.code === 'auth/account-exists-with-different-credential') {
                        errorMessage = 'An account with this email already exists using different credentials.';
                    }
                    showMessage(signUpError, errorMessage);
                }
            });
        }

        // GitHub Sign Up
        if (githubSignUpBtn) { // Safety check
            githubSignUpBtn.addEventListener('click', async () => {
                const provider = new GithubAuthProvider();
                if (signUpError) signUpError.textContent = '';
                try {
                    const userCredential = await signInWithPopup(auth, provider);
                    const user = userCredential.user;
                    const currentUserId = user.uid;

                    // Firestore profile creation for social sign-up
                    const appId = firebaseConfig.projectId;
                    const userProfileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/user_profiles`, "profile");
                    const docSnap = await getDoc(userProfileDocRef);

                    if (!docSnap.exists()) {
                        await setDoc(userProfileDocRef, {
                            email: user.email,
                            createdAt: new Date().toISOString()
                        });
                    }

                    showMessage(signUpSuccess, 'Signed up with GitHub successfully! Redirecting to profile setup...', 'success');
                    setTimeout(() => {
                        window.location.href = 'ls/su2.html';
                    }, 2000);
                } catch (error) {
                    console.error("GitHub Sign Up Error:", error);
                    let errorMessage = 'GitHub sign-up failed.';
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'GitHub sign-up popup closed.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = 'GitHub sign-up already in progress.';
                    } else if (error.code === 'auth/account-exists-with-different-credential') {
                        errorMessage = 'An account with this email already exists using different credentials.';
                    }
                    showMessage(signUpError, errorMessage);
                }
            });
        }

        // Facebook Sign Up
        if (facebookSignUpBtn) { // Safety check
            facebookSignUpBtn.addEventListener('click', async () => {
                const provider = new FacebookAuthProvider();
                // You might need to add Facebook scopes if you need more user data:
                // provider.addScope('public_profile');
                // provider.addScope('email');
                if (signUpError) signUpError.textContent = '';
                try {
                    const userCredential = await signInWithPopup(auth, provider);
                    const user = userCredential.user;
                    const currentUserId = user.uid;

                    // Firestore profile creation for social sign-up
                    const appId = firebaseConfig.projectId;
                    const userProfileDocRef = doc(db, `artifacts/${appId}/users/${currentUserId}/user_profiles`, "profile");
                    const docSnap = await getDoc(userProfileDocRef);

                    if (!docSnap.exists()) {
                        await setDoc(userProfileDocRef, {
                            email: user.email,
                            createdAt: new Date().toISOString()
                        });
                    }

                    showMessage(signUpSuccess, 'Signed up with Facebook successfully! Redirecting to profile setup...', 'success');
                    setTimeout(() => {
                        window.location.href = 'ls/su2.html';
                    }, 2000);
                } catch (error) {
                    console.error("Facebook Sign Up Error:", error);
                    let errorMessage = 'Facebook sign-up failed.';
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Facebook sign-up popup closed.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = 'Facebook sign-up already in progress.';
                    } else if (error.code === 'auth/account-exists-with-different-credential') {
                        errorMessage = 'An account with this email already exists using different credentials.';
                    }
                    showMessage(signUpError, errorMessage);
                }
            });
        }

        // Redirect if already authenticated
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const appId = firebaseConfig.projectId;
                const userProfileDocRef = doc(db, `artifacts/${appId}/users/${user.uid}/user_profiles`, "profile");
                try {
                    const docSnap = await getDoc(userProfileDocRef);
                    // Check if the user is already on the target page to avoid a redirect loop
                    if (window.location.pathname.endsWith('su2.html') && (!docSnap.exists() || !docSnap.data().name || !docSnap.data().phoneNumber)) {
                        // Do nothing, already on the correct page to complete profile
                        return;
                    } else if (window.location.pathname.endsWith('account.html') && docSnap.exists() && docSnap.data().name && docSnap.data().phoneNumber) {
                        // Do nothing, already on the correct page
                        return;
                    }
                    if (docSnap.exists() && docSnap.data().name && docSnap.data().phoneNumber) {
                        // If profile exists and has name/phone, go to account
                        window.location.href = '../account.html';
                    } else {
                        // Otherwise, go to profile completion
                        window.location.href = 'su2.html';
                    }
                } catch (error) {
                    console.error("Error checking user profile on signup page:", error);
                    // Fallback to account.html if profile check fails
                    window.location.href = '../account.html';
                }
            }
        });

        // Menu toggle function from the template
        const Menuitems = document.getElementById('Menuitems');

        window.menutoggle = function() {
            if (Menuitems) {
                if (Menuitems.style.maxHeight == "0px") {
                    Menuitems.style.maxHeight = "200px";
                } else {
                    Menuitems.style.maxHeight = "0px";
                }
            }
        };
    </script>
</body>
</html>
