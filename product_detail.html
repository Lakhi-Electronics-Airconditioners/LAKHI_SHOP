<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakhi Airconditioners | Product Details</title>
    <meta name="description" content="Veiw one product only (will not work if S/R number is not in the URL)">
    <link rel="icon" href="img/1x1-logo.png">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.css">
    <link rel="stylesheet" href="DOWNLOADED CSS/fontawesome-free-6.7.2-web/css/all.min.css">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(() => console.log('✅ Service Worker registered'))
                .catch(err => console.error('❌ Service Worker error:', err));
        }
    </script>
</head>
<body>
    <!-- Terms and Conditions Modal (Initial Agreement) -->
    <div id="tacpp" class="w3-modal-content">
        <div class="w3-center" style="margin-bottom:20px;">
            <span 
                onclick="closeModal()" 
                class="close-button" 
                title="Close Modal">
                Close ×
            </span>
            <h2>Please Agree to Proceed</h2>
        </div>
        <form class="w3-container">
            <!-- Agreement Checkbox -->
            <div class="w3-section" style="margin-bottom:20px; text-align:left;">
                <input type="checkbox" id="agree">
                <label for="agree">
                    I agree to the 
                    <a href="../info/TAC">
                        Terms and Conditions
                    </a> 
                    and 
                    <a href="../info/PP">
                        Privacy Policy
                    </a>.
                </label>
            </div>
            <!-- Disclaimer Section -->
            <p style="font-size:14px; margin-bottom:20px;">
                * Prices may not be accurate, and not all products are listed.<br>
                *product may not be in stock or may not even be buyable <br>
                * price may go down because of some gst/cst payment things
            </p>
            <!-- Continue Button -->
            <div class="w3-center">
                <button 
                    type="button"
                    class="btn-modal" 
                    onclick="continueAction(event)">
                    Continue
                </button>
            </div>
        </form>
    </div>

    <!-- Terms and Conditions Update Modal -->
    <div id="updateTacppModal" class="w3-modal-content">
        <div class="w3-center" style="margin-bottom:20px;">
            <span 
                onclick="closeUpdateModal()" 
                class="close-button" 
                title="Close Modal">
                Close ×
            </span>
            <h2>Terms and Conditions Updated</h2>
        </div>
        <form class="w3-container">
            <!-- Update Agreement Checkbox -->
            <div class="w3-section" style="margin-bottom:20px; text-align:left;">
                <p>Our Terms and Conditions and Privacy Policy have been updated. Please review the changes and agree to continue.</p>
                <input type="checkbox" id="agreeUpdate">
                <label for="agreeUpdate">
                    I agree to the updated 
                    <a href="../info/TAC">
                        Terms and Conditions
                    </a> 
                    and 
                    <a href="../info/PP">
                        Privacy Policy
                    </a>.
                </label>
            </div>
            <!-- Continue Button for Update -->
            <div class="w3-center">
                <button 
                    type="button"
                    class="btn-modal" 
                    onclick="continueUpdateAction(event)">
                    Agree to Update
                </button>
            </div>
        </form>
    </div>
    <script src="TACPP.js" defer></script>
    <div class="header-NAV">
        <div class="container">
            <div class="navbar">
                <div class="logo"><img src="img/NABR/log.jpg" width="125px" alt="lakhi airconditioners logo"></div>
                <nav>
                    <ul id="Menuitems">
                        <li><a href="/">Home</a></li>
                        <li><a href="about">About Us</a></li>
                        <li><a href="products">All Products</a></li>
                        <li><a href="contact">Contact Us</a></li>
                        <li><a href="account">Account</a></li>
                    </ul>
                </nav>
                <a href="cart"><img src="img/NABR/SCI.png" width="30px" alt="shopping cart icon"></a>
                <img src="img/NABR/menu.png" class="menu-icon" onclick="menutoggle()" alt="menu icon">
            </div>
        </div>
    </div>
    <div class="color-NAV"><br><br></div>
    
    <div class="small-container single-product">
        <a href="#" class="back-button" onclick="history.back(); return false;">&larr; Back to Products</a>
        <div class="row" id="productDetailContainer">
            <div class="col-2">
                <img src="/img/PROC/Loading.gif" alt="Loading Product Image">
            </div>
            <div class="col-2">
                <p>Category: Loading...</p>
                <h3>S/R no: Loading... </h3>
                <h1>Loading Product Name...</h1>
                <h4>Loading Price...</h4>
                
                <div class="size-selector-container">
                    <label for="product-size">Select Size:</label>
                    <select id="product-size" class="large-size-selector">
                        <option value="N/A">N/A</option>
                    </select>
                </div>

                <div class="add-to-cart-section" style="margin-top: 20px; display: flex; align-items: center;">
                    <label for="product-quantity" class="visually-hidden">Quantity</label>
                    <input type="number" value="1" min="1" id="product-quantity" class="quantity-input" style="width: 70px; text-align: center; margin-right: 5px;" placeholder="Qty" title="Enter quantity">
                    <span id="product-unit-display" style="margin-right: 15px; font-weight: bold; color: #555;">unit</span>
                    <a href="#" class="btn-Cart" id="add-to-cart-btn">Add To Cart</a>
                </div>
                <h3>Product Details <i class="fa-solid fa-indent"></i></h3>
                <p>Loading Description...</p>
                <div class="rating">
                    <span>
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                        <i class="fa-regular fa-star"></i>
                    </span>
                    <p style="font-size: 10px; margin: 0;">No rating info</p>
                </div>
            </div>
            <div class="col-1">
                <h3>Product Details <i class="fa-solid fa-indent"></i></h3><br>
                <p>Loading Description...</p><br>
                <h3>Product Info <i class="fa-solid fa-info"></i></h3><br>
                <p>Loading Info...</p><br>
                <h3>Checking if AC</h3><br>
                <p><b>AC Tonnage:</b> loading... </p>
                <p><b>AC Type:</b> loading ac type</p>
                <p><b>Energy Rating:</b> loading Stars</p>
                <p><b>Inverter /Non-Inverter:</b> loading</p>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="container">
            <div class="row">
                <div class="foot-col-1">
                    <h3>Download Our App</h3>
                    <p>Download App for Android but not <u>iphone</u> for now</p>
                    <div class="app-logo">
                        <a href="https://drive.google.com/uc?export=download&id=1jx18KtEjAwaQtto0XqbPWe8cz49oUuUG"><img src="img/NABR/apk-down.jpeg" alt="apk downlaod button"></a>
                    </div>
                </div>
                <div class="foot-col-2">
                    <img src="img/log-w.png" width="200px" alt="lakhi airconditioners all white logo">
                    <p>Our Purpose Is to give the best deal and products to the Many.</p>
                </div>
                <div class="foot-col-3">
                    <h3>Useful links</h3>
                    <ul>
                        <Li><a href="https://main.lakhiairconditioners.com/TAC">Terms and Conditions</a></Li>
                        <Li><a href="https://main.lakhiairconditioners.com/PP">Privacy Policy</a></Li>
                        <li><a href="https://lakhiairconditioners.com">INFO</a></li>
                        <li><a href="https://maps.lakhiairconditioners.com">G-MAPS</a></li>
                    </ul>
                </div>
                <div class="foot-col-4">
                    <h3>Follow us</h3>
                    <ul>
                        <Li><a href="https://insta.lakhiairconditioners.com/">Instagram</a></Li>
                        <Li><a href="https://fb.lakhiairconditioners.com/">Facebook</a></Li>
                    </ul>
                    <h3 style="margin-top: 20px">Contact info</h3>
                    <ul>
                        <li><a href="tel:+919825513000">+919825513000</a></li>
                        <li><a href="mailto:info@lakhiairconditioners?subject=Feedback&amp;body=Hi%20there,%20I%20have%20some%20feedback%20for%20you.">info@lakhiairconditioners.com</a></li>
                        <li><a href="https://bc.lakhiairconditioners.com">Business-card</a></li>
                    </ul>
                </div>
            </div>
            <hr>
            <p class="copyright">&copy; 2025 Lakhi Airconditioners. All rights reserved.<br>
                all right given to fontawesome for their icons
                <a href="https://www.flaticon.com/free-icons/menu" title="menu icons">Menu icons created by ariefstudio - Flaticon</a></p>

        </div>
    </div>

    <script>
        var Menuitems = document.getElementById('Menuitems');
        Menuitems.style.maxHeight = "0px";

        function menutoggle() {
            if (Menuitems.style.maxHeight == "0px") {
                Menuitems.style.maxHeight = "200px";
            } else {
                Menuitems.style.maxHeight = "0px";
            }
        }

        // New function for handling image loading errors with fallbacks
        function handleImageError(imgElement, serialNo) {
            // Check if we've already tried the serial number fallback
            if (!imgElement.dataset.serialFallbackAttempted) {
                imgElement.dataset.serialFallbackAttempted = 'true'; // Mark as attempted
                imgElement.src = `img/PROC/${serialNo}.png`; // Try serial number image
                console.log(`Image failed for ${serialNo}. Trying fallback: img/PROC/${serialNo}.png`);
            } else {
                // If serial number fallback was already attempted and failed, use final default
                imgElement.onerror = null; // Prevent infinite loop for DP.png if it somehow fails
                imgElement.src = 'img/PROC/DP.gif';
                console.log(`Serial number fallback failed for ${serialNo}. Using final fallback: img/PROC/DP.png`);
            }
        }
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        // Import Firestore modules for fetching a single document using a query
        import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyC-16u2n4IaGRmg88nsPmMYCGKp2jjL9Bg",
            authDomain: "lakhi-airconditioners.firebaseapp.com",
            projectId: "lakhi-airconditioners",
            storageBucket: "lakhi-airconditioners.firebasestorage.app",
            messagingSenderId: "284430318185",
            appId: "1:284430318185:web:ad09598be7a16ab46a00f8",
            measurementId: "G-LB63B1FRYC"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Ensure this APP_ID matches the projectId in your firebaseConfig
        const FIRESTORE_APP_ID = "lakhi-airconditioners"; 

        // --- Cart Functions ---
        // Function to get cart items from localStorage
        function getCartItems() {
            const cartItemsString = localStorage.getItem('cartitems');
            return cartItemsString ? JSON.parse(cartItemsString) : [];
        }

        // Function to save cart items to localStorage
        function saveCartItems(cartItems) {
            localStorage.setItem('cartitems', JSON.stringify(cartItems));
        }

        // Function to add an item to the cart - now accepts 'unit' and 'productName'
        function addToCart(serialNo, quantity, size, unit, productName) {
            let cartItems = getCartItems();
            // Find if item with same serialNo AND size (variant) already exists
            const existingItemIndex = cartItems.findIndex(item => item.serial_no === serialNo && item.size === size);

            if (existingItemIndex > -1) {
                cartItems[existingItemIndex].quantity += quantity;
            } else {
                // Include the unit when adding a new item to cart
                cartItems.push({ serial_no: serialNo, quantity: quantity, size: size, unit: unit });
            }
            saveCartItems(cartItems);
            alert(`Added ${quantity} ${unit} of ${productName} (Size: ${size}) to cart!`); // Updated alert
            console.log('Current cartitems:', cartItems);
        }
        // --- End Cart Functions ---

        // Function to generate star ratings HTML based on a numeric rating
        function generateStars(rating) {
            let starsHTML = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 !== 0;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

            for (let i = 0; i < fullStars; i++) {
                starsHTML += '<i class="fa-solid fa-star"></i>';
            }
            if (hasHalfStar) {
                starsHTML += '<i class="fa-solid fa-star-half-stroke"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                starsHTML += '<i class="fa-regular fa-star"></i>';
            }
            return starsHTML;
        }
        // New function to update the meta description
        function updateMetaDescription(description) {
            const metaTag = document.querySelector('meta[name="description"]');
            let newDescription = description || "Sorry, the following product does not have a description.";
            const maxLength = 160; // A good limit for SEO

            if (newDescription.length > maxLength) {
                newDescription = newDescription.substring(0, maxLength - 3) + '...';
            }
            metaTag.setAttribute('content', newDescription);
        }
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const serialNo = urlParams.get('serial_no');
            const productDetailContainer = document.getElementById('productDetailContainer');
            let productSizeSelect;
            let productQuantityInput;
            let addToCartBtn;
            let productUnitDisplay;

            let currentProduct = null;


            // Display loading state initially
            productDetailContainer.innerHTML = `
                <div class="col-2">
                    <img src="/img/PROC/Loading.gif" alt="Loading Product Image">
                </div>
                <div class="col-2">
                    <p>Category: Loading...</p>
                    <h3>S/R no: Loading... </h3>
                    <h1>Loading Product Name...</h1>
                    <h4>Loading Price...</h4>
                    <div class="size-selector-container">
                        <label for="product-size">Select Size:</label>
                        <select id="product-size" class="large-size-selector" disabled>
                            <option>Loading...</option>
                        </select>
                    </div>
                    <div class="add-to-cart-section" style="margin-top: 20px; display: flex; align-items: center;">
                        <input type="number" value="1" min="1" id="product-quantity" class="quantity-input" style="width: 70px; text-align: center; margin-right: 5px;" disabled>
                        <span id="product-unit-display" style="margin-right: 15px; font-weight: bold; color: #555;">unit</span>
                        <a href="#" class="btn-Cart disabled" id="add-to-cart-btn">Add To Cart</a>
                    </div>
                    <div class="rating"><span>Loading rating...</span></div>
                </div>
                <div class="col-1">
                    <h3>Product Details <i class="fa-solid fa-indent"></i></h3><br>
                    <p>Loading Description...</p><br>
                    <h3>Product Info <i class="fa-solid fa-info"></i></h3><br>
                    <p>Loading Info...</p><br>
                    <h3>Checking if AC</h3><br>
                    <p><b>AC Tonnage:</b> loading... </p>
                    <p><b>AC Type:</b> loading ac type</p>
                    <p><b>Energy Rating:</b> loading Stars</p>
                    <p><b>Inverter /Non-Inverter:</b> loading</p>
                </div>
            `;

            if (serialNo) {
                try {
                    // --- CHANGED: Query by serial_no field instead of document ID ---
                    const productsCollectionRef = collection(db, "artifacts", FIRESTORE_APP_ID, "products");
                    const q = query(productsCollectionRef, where("serial_no", "==", serialNo));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        // Assuming serial_no is unique, get the first matching document
                        currentProduct = querySnapshot.docs[0].data();
                    if (currentProduct && currentProduct.serial_no) {
                        const sr = currentProduct.serial_no;
                        document.title = `Lakhi Airconditioners | Product Details | ${sr}`;
                        // Dynamically update the meta description after fetching the product
                        updateMetaDescription(currentProduct.description);
                    
                    }
                     

                        
                        // Prioritize image_url from Firestore, otherwise use the existing local path logic
                        const imageSrc = currentProduct.image_url || `img/PROC/${currentProduct.serial_no.replace(/\//g, '!')}.jpg`;
                        let formattedPrice = currentProduct.price ? `₹${parseFloat(currentProduct.price).toLocaleString('en-IN')}` : 'Price not available';
                        let stars = currentProduct.rating_stars !== null && currentProduct.rating !== undefined ? generateStars(currentProduct.rating) : 'No rating';
                        let ratingSourcePath = currentProduct.rating_icon ? currentProduct.rating_icon : '';

                        productDetailContainer.innerHTML = `
                            <div class="col-2">
                                <img src="${imageSrc}"
                                     alt="${currentProduct.name}" 
                                     onerror="handleImageError(this, '${currentProduct.serial_no}');"
                                     style="display: flex;justify-content: center;align-items: center;">
                            </div>
                            <div class="col-2">
                                <p>Category: ${currentProduct.type || 'N/A'}</p>
                                <h3>S/R no: ${currentProduct.serial_no}</h3>
                                <h1>${currentProduct.name}</h1>
                                <h4 class="dynamic-price">${formattedPrice}</h4>
                                
                                <div class="size-selector-container">
                                    <label for="product-size">Select Size:</label>
                                    <select id="product-size" class="large-size-selector">
                                        </select>
                                </div>

                                <div class="add-to-cart-section" style="margin-top: 20px; display: flex; align-items: center;">
                                    <input type="number" value="1" min="1" id="product-quantity" class="quantity-input" style="width: 70px; text-align: center; margin-right: 5px;">
                                    <span id="product-unit-display" style="margin-right: 15px; font-weight: bold; color: #555;">${currentProduct.unit || 'unit'}</span>
                                    <a href="#" class="btn-Cart" id="add-to-cart-btn">Add To Cart</a>
                                </div>
                                <div class="rating" style="">
                                    <span>
                                        ${stars}
                                    </span>
                                    ${ratingSourcePath ? `<p style="font-size: 10px; margin: 0;">  Based on <img src="${ratingSourcePath}" class="rating-source-icon"></p>` : ''}
                                </div>
                            </div>
                            <div class="col-1">
                                <div>
                                <h3>Product Details <i class="fa-solid fa-indent"></i></h3>
                                <p>${currentProduct.description || 'No description available.'}</p>
                                </div>
                                <div><br>
                                <h3>Product Info <i class="fa-solid fa-info"></i></h3>
                                <p>${currentProduct.info || 'No Info available.'}</p>
                                <br><br>
                                </div>
                                <div id="ac_info">
                                <h3>AC INFO</h3>
                                ${currentProduct['ac_tr'] ? `<p><b>AC Tonnage:</b> ${currentProduct['ac_tr']} Ton</p>` : ''}
                                ${currentProduct['ac_type'] ? `<p><b>AC Type:</b> ${currentProduct['ac_type']}</p>` : ''}
                                ${currentProduct['ac_stars'] ? `<p><b>Energy Rating:</b> ${currentProduct['ac_stars']} Star</p>` : ''}
                                ${currentProduct['ac_inv'] ? `<p><b>Inverter /Non-Inverter:</b> ${currentProduct['ac_inv']}</p>` : ''}
                            </div>
                        `;

                        // Re-select elements after innerHTML update
                        productSizeSelect = document.getElementById('product-size');
                        productQuantityInput = document.getElementById('product-quantity');
                        addToCartBtn = document.getElementById('add-to-cart-btn');
                        productUnitDisplay = document.getElementById('product-unit-display');

                        // Populate size options
                        if (currentProduct.type === 'AC' && currentProduct['ac_tr']) {
                            const option = document.createElement('option');
                            option.value = `${currentProduct['ac_tr']} Ton`;
                            option.textContent = `${currentProduct['ac_tr']} Ton`;
                            productSizeSelect.appendChild(option);
                        } else {
                            const option = document.createElement('option');
                            option.value = 'N/A';
                            option.textContent = 'N/A';
                            productSizeSelect.appendChild(option);
                            productSizeSelect.disabled = true;
                        }
                        productUnitDisplay.textContent = currentProduct.unit || 'unit';
                        
                        const ac_info = document.getElementById('ac_info');
                        if (currentProduct.type === 'AC') {
                            ac_info.style.display = "block"; // Show the message
                        } 
                        else {
                            ac_info.style.display = "none"; // Hide the message
                        }

                        // Re-attach event listener for the "Add To Cart" button
                        addToCartBtn.addEventListener('click', function(event) {
                            event.preventDefault();
                            const quantity = parseInt(productQuantityInput.value, 10);
                            const selectedSize = productSizeSelect.value;
                            const productUnit = currentProduct.unit;
                            const productName = currentProduct.name;
                            if (quantity > 0) {
                                addToCart(currentProduct.serial_no, quantity, selectedSize, productUnit, productName);
                            } else {
                                alert("Please enter a valid quantity (at least 1).");
                            }
                        });

                    } else {
                        // If query snapshot is empty, no product found with that serial_no field value
                        productDetailContainer.innerHTML = '<p style="text-align: center; width: 100%;">Product not found with the provided serial number.</p>';
                    }
                } catch (error) {
                    console.error('Error fetching product data from Firestore:', error);
                    productDetailContainer.innerHTML = '<p style="text-align: center; width: 100%; color: red;">Failed to load product details. Please check your internet connection or Firebase permissions.</p>';
                }
            } else {
                productDetailContainer.innerHTML = '<p style="text-align: center; width: 100%;">No product serial number provided in the URL.</p>';
            }
        });
    </script>
</body>
</html>